<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="A proactive AI Chief of Staff"><link href=https://reubenjohn.github.io/reeve-bot/architecture/pulse-queue/ rel=canonical><link href=../project-structure/ rel=prev><link href=../mcp-integration/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.7.1"><title>Pulse Queue Design - Project Reeve</title><link rel=stylesheet href=../../assets/stylesheets/main.484c7ddc.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.ab4e12ef.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent=amber> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#pulse-queue-design class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title="Project Reeve" class="md-header__button md-logo" aria-label="Project Reeve" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Project Reeve </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Pulse Queue Design </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=deep-purple data-md-color-accent=amber aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=deep-purple data-md-color-accent=amber aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/reubenjohn/reeve-bot title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> reubenjohn/reeve-bot </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title="Project Reeve" class="md-nav__button md-logo" aria-label="Project Reeve" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> Project Reeve </label> <div class=md-nav__source> <a href=https://github.com/reubenjohn/reeve-bot title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg> </div> <div class=md-source__repository> reubenjohn/reeve-bot </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2 checked> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex> <span class=md-ellipsis> Architecture </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=true> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> Architecture </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../project-structure/ class=md-nav__link> <span class=md-ellipsis> Project Structure </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Pulse Queue Design </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Pulse Queue Design </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#overview class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#core-concepts class=md-nav__link> <span class=md-ellipsis> Core Concepts </span> </a> <nav class=md-nav aria-label="Core Concepts"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-pulse class=md-nav__link> <span class=md-ellipsis> 1. Pulse </span> </a> </li> <li class=md-nav__item> <a href=#2-priority-system class=md-nav__link> <span class=md-ellipsis> 2. Priority System </span> </a> </li> <li class=md-nav__item> <a href=#3-pulse-status-lifecycle class=md-nav__link> <span class=md-ellipsis> 3. Pulse Status Lifecycle </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#database-schema class=md-nav__link> <span class=md-ellipsis> Database Schema </span> </a> <nav class=md-nav aria-label="Database Schema"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#pulse-model class=md-nav__link> <span class=md-ellipsis> Pulse Model </span> </a> </li> <li class=md-nav__item> <a href=#alembic-migration-strategy class=md-nav__link> <span class=md-ellipsis> Alembic Migration Strategy </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#queue-management-logic class=md-nav__link> <span class=md-ellipsis> Queue Management Logic </span> </a> <nav class=md-nav aria-label="Queue Management Logic"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#pulsequeue-class class=md-nav__link> <span class=md-ellipsis> PulseQueue Class </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#design-decisions-rationale class=md-nav__link> <span class=md-ellipsis> Design Decisions &amp; Rationale </span> </a> <nav class=md-nav aria-label="Design Decisions & Rationale"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-why-async-sqlalchemy class=md-nav__link> <span class=md-ellipsis> 1. Why Async SQLAlchemy? </span> </a> </li> <li class=md-nav__item> <a href=#2-why-string-enums class=md-nav__link> <span class=md-ellipsis> 2. Why String Enums? </span> </a> </li> <li class=md-nav__item> <a href=#3-why-composite-indexes class=md-nav__link> <span class=md-ellipsis> 3. Why Composite Indexes? </span> </a> </li> <li class=md-nav__item> <a href=#4-why-retry-logic-in-db class=md-nav__link> <span class=md-ellipsis> 4. Why Retry Logic in DB? </span> </a> </li> <li class=md-nav__item> <a href=#5-why-separate-created_by-field class=md-nav__link> <span class=md-ellipsis> 5. Why Separate created_by Field? </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#execution-flow class=md-nav__link> <span class=md-ellipsis> Execution Flow </span> </a> <nav class=md-nav aria-label="Execution Flow"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#daemon-main-loop class=md-nav__link> <span class=md-ellipsis> Daemon Main Loop </span> </a> </li> <li class=md-nav__item> <a href=#parallel-execution class=md-nav__link> <span class=md-ellipsis> Parallel Execution </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#next-steps class=md-nav__link> <span class=md-ellipsis> Next Steps </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../mcp-integration/ class=md-nav__link> <span class=md-ellipsis> MCP Integration </span> </a> </li> <li class=md-nav__item> <a href=../daemon-api/ class=md-nav__link> <span class=md-ellipsis> Daemon & API </span> </a> </li> <li class=md-nav__item> <a href=../deployment/ class=md-nav__link> <span class=md-ellipsis> Deployment </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_3> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> Roadmap </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Roadmap </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roadmap/ class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=../../roadmap/phase-1-foundation/ class=md-nav__link> <span class=md-ellipsis> Phase 1 - Foundation </span> </a> </li> <li class=md-nav__item> <a href=../../roadmap/phase-2-queue/ class=md-nav__link> <span class=md-ellipsis> Phase 2 - Queue </span> </a> </li> <li class=md-nav__item> <a href=../../roadmap/phase-3-mcp/ class=md-nav__link> <span class=md-ellipsis> Phase 3 - MCP </span> </a> </li> <li class=md-nav__item> <a href=../../roadmap/phase-4-executor/ class=md-nav__link> <span class=md-ellipsis> Phase 4 - Executor </span> </a> </li> <li class=md-nav__item> <a href=../../roadmap/phase-5-daemon/ class=md-nav__link> <span class=md-ellipsis> Phase 5 - Daemon </span> </a> </li> <li class=md-nav__item> <a href=../../roadmap/phase-6-api/ class=md-nav__link> <span class=md-ellipsis> Phase 6 - API </span> </a> </li> <li class=md-nav__item> <a href=../../roadmap/phase-7-telegram/ class=md-nav__link> <span class=md-ellipsis> Phase 7 - Telegram </span> </a> </li> <li class=md-nav__item> <a href=../../roadmap/phase-8-deployment/ class=md-nav__link> <span class=md-ellipsis> Phase 8 - Deployment </span> </a> </li> <li class=md-nav__item> <a href=../../roadmap/phase-9-testing/ class=md-nav__link> <span class=md-ellipsis> Phase 9 - Testing </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> Guides </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> Guides </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../MCP_SETUP/ class=md-nav__link> <span class=md-ellipsis> MCP Setup </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex> <span class=md-ellipsis> Reference </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Reference </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../OpenClaw_COMPARISON/ class=md-nav__link> <span class=md-ellipsis> OpenClaw Comparison </span> </a> </li> <li class=md-nav__item> <a href=../../IDEAS/ class=md-nav__link> <span class=md-ellipsis> Ideas & Future </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=https://github.com/reubenjohn/reeve-bot/blob/master/CONTRIBUTING.md class=md-nav__link> <span class=md-ellipsis> Contributing </span> </a> </li> <li class=md-nav__item> <a href=https://github.com/reubenjohn/reeve-bot/blob/master/SECURITY.md class=md-nav__link> <span class=md-ellipsis> Security </span> </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#overview class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#core-concepts class=md-nav__link> <span class=md-ellipsis> Core Concepts </span> </a> <nav class=md-nav aria-label="Core Concepts"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-pulse class=md-nav__link> <span class=md-ellipsis> 1. Pulse </span> </a> </li> <li class=md-nav__item> <a href=#2-priority-system class=md-nav__link> <span class=md-ellipsis> 2. Priority System </span> </a> </li> <li class=md-nav__item> <a href=#3-pulse-status-lifecycle class=md-nav__link> <span class=md-ellipsis> 3. Pulse Status Lifecycle </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#database-schema class=md-nav__link> <span class=md-ellipsis> Database Schema </span> </a> <nav class=md-nav aria-label="Database Schema"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#pulse-model class=md-nav__link> <span class=md-ellipsis> Pulse Model </span> </a> </li> <li class=md-nav__item> <a href=#alembic-migration-strategy class=md-nav__link> <span class=md-ellipsis> Alembic Migration Strategy </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#queue-management-logic class=md-nav__link> <span class=md-ellipsis> Queue Management Logic </span> </a> <nav class=md-nav aria-label="Queue Management Logic"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#pulsequeue-class class=md-nav__link> <span class=md-ellipsis> PulseQueue Class </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#design-decisions-rationale class=md-nav__link> <span class=md-ellipsis> Design Decisions &amp; Rationale </span> </a> <nav class=md-nav aria-label="Design Decisions & Rationale"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#1-why-async-sqlalchemy class=md-nav__link> <span class=md-ellipsis> 1. Why Async SQLAlchemy? </span> </a> </li> <li class=md-nav__item> <a href=#2-why-string-enums class=md-nav__link> <span class=md-ellipsis> 2. Why String Enums? </span> </a> </li> <li class=md-nav__item> <a href=#3-why-composite-indexes class=md-nav__link> <span class=md-ellipsis> 3. Why Composite Indexes? </span> </a> </li> <li class=md-nav__item> <a href=#4-why-retry-logic-in-db class=md-nav__link> <span class=md-ellipsis> 4. Why Retry Logic in DB? </span> </a> </li> <li class=md-nav__item> <a href=#5-why-separate-created_by-field class=md-nav__link> <span class=md-ellipsis> 5. Why Separate created_by Field? </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#execution-flow class=md-nav__link> <span class=md-ellipsis> Execution Flow </span> </a> <nav class=md-nav aria-label="Execution Flow"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#daemon-main-loop class=md-nav__link> <span class=md-ellipsis> Daemon Main Loop </span> </a> </li> <li class=md-nav__item> <a href=#parallel-execution class=md-nav__link> <span class=md-ellipsis> Parallel Execution </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#next-steps class=md-nav__link> <span class=md-ellipsis> Next Steps </span> </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=pulse-queue-design>Pulse Queue Design<a class=headerlink href=#pulse-queue-design title="Permanent link">&para;</a></h1> <h2 id=overview>Overview<a class=headerlink href=#overview title="Permanent link">&para;</a></h2> <p>The Pulse Queue is the core scheduling mechanism that enables Reeve's proactive behavior. It manages when and why Reeve should "wake up" to perform tasks, check for updates, or process information.</p> <h2 id=core-concepts>Core Concepts<a class=headerlink href=#core-concepts title="Permanent link">&para;</a></h2> <h3 id=1-pulse>1. Pulse<a class=headerlink href=#1-pulse title="Permanent link">&para;</a></h3> <p>A <strong>Pulse</strong> represents a single scheduled wake-up event for Reeve. Each pulse contains:</p> <ul> <li><strong>When</strong> to wake up (<code>scheduled_at</code>)</li> <li><strong>Why</strong> to wake up (<code>prompt</code> - the context/task)</li> <li><strong>How urgent</strong> it is (<code>priority</code>)</li> <li><strong>What context</strong> to resume (<code>session_id</code>, <code>sticky_notes</code>)</li> <li><strong>Current state</strong> (<code>status</code>)</li> </ul> <h3 id=2-priority-system>2. Priority System<a class=headerlink href=#2-priority-system title="Permanent link">&para;</a></h3> <p>Pulses have different priority levels to manage Reeve's attention:</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=k>class</span><span class=w> </span><span class=nc>PulsePriority</span><span class=p>(</span><span class=nb>str</span><span class=p>,</span> <span class=n>Enum</span><span class=p>):</span>
<a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=sd>    Priority levels for pulses, determining execution order when multiple</span>
<a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=sd>    pulses are due at the same time.</span>
<a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a>
<a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=sd>    Higher priority pulses are processed first. Priority also affects</span>
<a id=__codelineno-0-7 name=__codelineno-0-7 href=#__codelineno-0-7></a><span class=sd>    interrupt behavior and user notification urgency.</span>
<a id=__codelineno-0-8 name=__codelineno-0-8 href=#__codelineno-0-8></a><span class=sd>    &quot;&quot;&quot;</span>
<a id=__codelineno-0-9 name=__codelineno-0-9 href=#__codelineno-0-9></a>
<a id=__codelineno-0-10 name=__codelineno-0-10 href=#__codelineno-0-10></a>    <span class=n>CRITICAL</span> <span class=o>=</span> <span class=s2>&quot;critical&quot;</span>    <span class=c1># üö® Emergency: User messages, system failures</span>
<a id=__codelineno-0-11 name=__codelineno-0-11 href=#__codelineno-0-11></a>                             <span class=c1># - Interrupts deep work</span>
<a id=__codelineno-0-12 name=__codelineno-0-12 href=#__codelineno-0-12></a>                             <span class=c1># - Bypasses DND settings</span>
<a id=__codelineno-0-13 name=__codelineno-0-13 href=#__codelineno-0-13></a>                             <span class=c1># - Example: &quot;Wife texted: Emergency&quot;</span>
<a id=__codelineno-0-14 name=__codelineno-0-14 href=#__codelineno-0-14></a>
<a id=__codelineno-0-15 name=__codelineno-0-15 href=#__codelineno-0-15></a>    <span class=n>HIGH</span> <span class=o>=</span> <span class=s2>&quot;high&quot;</span>           <span class=c1># üîî Important: External events, user-facing tasks</span>
<a id=__codelineno-0-16 name=__codelineno-0-16 href=#__codelineno-0-16></a>                             <span class=c1># - Scheduled alarms the user set</span>
<a id=__codelineno-0-17 name=__codelineno-0-17 href=#__codelineno-0-17></a>                             <span class=c1># - External triggers (Telegram, Email)</span>
<a id=__codelineno-0-18 name=__codelineno-0-18 href=#__codelineno-0-18></a>                             <span class=c1># - Example: &quot;Check flight status before departure&quot;</span>
<a id=__codelineno-0-19 name=__codelineno-0-19 href=#__codelineno-0-19></a>
<a id=__codelineno-0-20 name=__codelineno-0-20 href=#__codelineno-0-20></a>    <span class=n>NORMAL</span> <span class=o>=</span> <span class=s2>&quot;normal&quot;</span>       <span class=c1># ‚è∞ Standard: Regular maintenance, scheduled checks</span>
<a id=__codelineno-0-21 name=__codelineno-0-21 href=#__codelineno-0-21></a>                             <span class=c1># - Periodic pulses (hourly check)</span>
<a id=__codelineno-0-22 name=__codelineno-0-22 href=#__codelineno-0-22></a>                             <span class=c1># - Calendar event reminders</span>
<a id=__codelineno-0-23 name=__codelineno-0-23 href=#__codelineno-0-23></a>                             <span class=c1># - Example: &quot;Daily 9 AM: Review calendar&quot;</span>
<a id=__codelineno-0-24 name=__codelineno-0-24 href=#__codelineno-0-24></a>
<a id=__codelineno-0-25 name=__codelineno-0-25 href=#__codelineno-0-25></a>    <span class=n>LOW</span> <span class=o>=</span> <span class=s2>&quot;low&quot;</span>             <span class=c1># üìã Background: Non-urgent maintenance</span>
<a id=__codelineno-0-26 name=__codelineno-0-26 href=#__codelineno-0-26></a>                             <span class=c1># - Cleanup tasks</span>
<a id=__codelineno-0-27 name=__codelineno-0-27 href=#__codelineno-0-27></a>                             <span class=c1># - Background research</span>
<a id=__codelineno-0-28 name=__codelineno-0-28 href=#__codelineno-0-28></a>                             <span class=c1># - Example: &quot;Weekly: Archive old notes&quot;</span>
<a id=__codelineno-0-29 name=__codelineno-0-29 href=#__codelineno-0-29></a>
<a id=__codelineno-0-30 name=__codelineno-0-30 href=#__codelineno-0-30></a>    <span class=n>DEFERRED</span> <span class=o>=</span> <span class=s2>&quot;deferred&quot;</span>   <span class=c1># üïê Postponed: Intentionally delayed</span>
<a id=__codelineno-0-31 name=__codelineno-0-31 href=#__codelineno-0-31></a>                             <span class=c1># - User explicitly snoozed a task</span>
<a id=__codelineno-0-32 name=__codelineno-0-32 href=#__codelineno-0-32></a>                             <span class=c1># - Rescheduled due to conflicts</span>
<a id=__codelineno-0-33 name=__codelineno-0-33 href=#__codelineno-0-33></a>                             <span class=c1># - Example: &quot;Moved from Monday to Friday&quot;</span>
</code></pre></div> <p><strong>Design Rationale</strong>: - <strong>String Enum</strong>: JSON-serializable, human-readable in DB - <strong>Explicit semantics</strong>: Each level has clear use cases - <strong>Emoji convention</strong>: Visual scanning in logs/UI - <strong>5 levels</strong>: Enough granularity without decision paralysis</p> <h3 id=3-pulse-status-lifecycle>3. Pulse Status Lifecycle<a class=headerlink href=#3-pulse-status-lifecycle title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=k>class</span><span class=w> </span><span class=nc>PulseStatus</span><span class=p>(</span><span class=nb>str</span><span class=p>,</span> <span class=n>Enum</span><span class=p>):</span>
<a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=sd>    Status of a pulse in its lifecycle.</span>
<a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a>
<a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=sd>    State transitions:</span>
<a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=sd>    PENDING -&gt; PROCESSING -&gt; COMPLETED (success)</span>
<a id=__codelineno-1-7 name=__codelineno-1-7 href=#__codelineno-1-7></a><span class=sd>                          -&gt; FAILED (error, will retry)</span>
<a id=__codelineno-1-8 name=__codelineno-1-8 href=#__codelineno-1-8></a><span class=sd>                          -&gt; CANCELLED (user/system cancelled)</span>
<a id=__codelineno-1-9 name=__codelineno-1-9 href=#__codelineno-1-9></a><span class=sd>    &quot;&quot;&quot;</span>
<a id=__codelineno-1-10 name=__codelineno-1-10 href=#__codelineno-1-10></a>
<a id=__codelineno-1-11 name=__codelineno-1-11 href=#__codelineno-1-11></a>    <span class=n>PENDING</span> <span class=o>=</span> <span class=s2>&quot;pending&quot;</span>         <span class=c1># Waiting to be executed</span>
<a id=__codelineno-1-12 name=__codelineno-1-12 href=#__codelineno-1-12></a>    <span class=n>PROCESSING</span> <span class=o>=</span> <span class=s2>&quot;processing&quot;</span>   <span class=c1># Currently executing</span>
<a id=__codelineno-1-13 name=__codelineno-1-13 href=#__codelineno-1-13></a>    <span class=n>COMPLETED</span> <span class=o>=</span> <span class=s2>&quot;completed&quot;</span>     <span class=c1># Successfully executed</span>
<a id=__codelineno-1-14 name=__codelineno-1-14 href=#__codelineno-1-14></a>    <span class=n>FAILED</span> <span class=o>=</span> <span class=s2>&quot;failed&quot;</span>           <span class=c1># Execution failed (see error_message)</span>
<a id=__codelineno-1-15 name=__codelineno-1-15 href=#__codelineno-1-15></a>    <span class=n>CANCELLED</span> <span class=o>=</span> <span class=s2>&quot;cancelled&quot;</span>     <span class=c1># Manually cancelled by user/system</span>
</code></pre></div> <p><strong>Design Rationale</strong>: - <strong>Simple states</strong>: Easy to reason about, no complex state machine - <strong>Processing state</strong>: Prevents duplicate execution (idempotency) - <strong>Failed vs Cancelled</strong>: Failed = retry possible, Cancelled = intentional stop</p> <pre class=mermaid><code>%%{init: {'theme': 'base', 'themeVariables': { 'lineColor': '#888'}}}%%
flowchart TD
    create(["schedule_pulse()"]) --&gt; pending["PENDING"]
    pending --&gt; |"Daemon detects due pulse"| processing
    processing["PROCESSING"]
    processing --&gt; |"Executor runs"| result{Result?}

    result --&gt; |Success| completed["COMPLETED"]
    result --&gt; |Failure| failed["FAILED"]

    failed --&gt; retry{"retry_count &lt; max?"}
    retry --&gt; |Yes| new_pending["New PENDING&lt;br/&gt;(exponential backoff)"]
    retry --&gt; |No| remains["Remains FAILED"]

    cancel(["cancel_pulse()"]) -.-&gt; |"At any time"| cancelled["CANCELLED"]
    pending -.-&gt; cancelled

    %% Styles
    classDef status fill:#4a90a4,stroke:#2e6b7a,color:#fff
    classDef success fill:#6b9b76,stroke:#4a7a54,color:#fff
    classDef failure fill:#c4955a,stroke:#a67940,color:#fff
    classDef action fill:#888,stroke:#666,color:#fff

    class pending,processing status
    class completed,new_pending success
    class failed,remains,cancelled failure
    class create,cancel,result,retry action</code></pre> <h2 id=database-schema>Database Schema<a class=headerlink href=#database-schema title="Permanent link">&para;</a></h2> <h3 id=pulse-model>Pulse Model<a class=headerlink href=#pulse-model title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=kn>from</span><span class=w> </span><span class=nn>sqlalchemy</span><span class=w> </span><span class=kn>import</span> <span class=n>Column</span><span class=p>,</span> <span class=n>Integer</span><span class=p>,</span> <span class=n>String</span><span class=p>,</span> <span class=n>DateTime</span><span class=p>,</span> <span class=n>Text</span><span class=p>,</span> <span class=n>Enum</span> <span class=k>as</span> <span class=n>SQLEnum</span><span class=p>,</span> <span class=n>JSON</span>
<a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=kn>from</span><span class=w> </span><span class=nn>sqlalchemy.ext.declarative</span><span class=w> </span><span class=kn>import</span> <span class=n>declarative_base</span>
<a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a><span class=kn>from</span><span class=w> </span><span class=nn>sqlalchemy.sql</span><span class=w> </span><span class=kn>import</span> <span class=n>func</span>
<a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=kn>from</span><span class=w> </span><span class=nn>datetime</span><span class=w> </span><span class=kn>import</span> <span class=n>datetime</span>
<a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>Optional</span><span class=p>,</span> <span class=n>List</span>
<a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>
<a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=n>Base</span> <span class=o>=</span> <span class=n>declarative_base</span><span class=p>()</span>
<a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a>
<a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=k>class</span><span class=w> </span><span class=nc>Pulse</span><span class=p>(</span><span class=n>Base</span><span class=p>):</span>
<a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=sd>    Represents a scheduled wake-up event for Reeve.</span>
<a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>
<a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=sd>    A pulse is the fundamental unit of Reeve&#39;s proactive behavior. It defines</span>
<a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a><span class=sd>    when Reeve should wake up, what it should think about, and with what urgency.</span>
<a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a>
<a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a><span class=sd>    Pulses can be:</span>
<a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=sd>    - Periodic (e.g., hourly heartbeat checks)</span>
<a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=sd>    - Aperiodic (e.g., &quot;check ticket prices at 6:45 AM tomorrow&quot;)</span>
<a id=__codelineno-2-19 name=__codelineno-2-19 href=#__codelineno-2-19></a><span class=sd>    - Event-triggered (e.g., external Telegram message arrives)</span>
<a id=__codelineno-2-20 name=__codelineno-2-20 href=#__codelineno-2-20></a>
<a id=__codelineno-2-21 name=__codelineno-2-21 href=#__codelineno-2-21></a><span class=sd>    Once a pulse executes, it launches a Hapi session with the pulse&#39;s prompt</span>
<a id=__codelineno-2-22 name=__codelineno-2-22 href=#__codelineno-2-22></a><span class=sd>    as the initial context, allowing Reeve to take action.</span>
<a id=__codelineno-2-23 name=__codelineno-2-23 href=#__codelineno-2-23></a><span class=sd>    &quot;&quot;&quot;</span>
<a id=__codelineno-2-24 name=__codelineno-2-24 href=#__codelineno-2-24></a>
<a id=__codelineno-2-25 name=__codelineno-2-25 href=#__codelineno-2-25></a>    <span class=n>__tablename__</span> <span class=o>=</span> <span class=s2>&quot;pulses&quot;</span>
<a id=__codelineno-2-26 name=__codelineno-2-26 href=#__codelineno-2-26></a>
<a id=__codelineno-2-27 name=__codelineno-2-27 href=#__codelineno-2-27></a>    <span class=c1># Primary Key</span>
<a id=__codelineno-2-28 name=__codelineno-2-28 href=#__codelineno-2-28></a>    <span class=nb>id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span><span class=n>Integer</span><span class=p>,</span> <span class=n>primary_key</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span> <span class=n>autoincrement</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
<a id=__codelineno-2-29 name=__codelineno-2-29 href=#__codelineno-2-29></a>
<a id=__codelineno-2-30 name=__codelineno-2-30 href=#__codelineno-2-30></a>    <span class=c1># Scheduling Information</span>
<a id=__codelineno-2-31 name=__codelineno-2-31 href=#__codelineno-2-31></a>    <span class=n>scheduled_at</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span>
<a id=__codelineno-2-32 name=__codelineno-2-32 href=#__codelineno-2-32></a>        <span class=n>DateTime</span><span class=p>(</span><span class=n>timezone</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>
<a id=__codelineno-2-33 name=__codelineno-2-33 href=#__codelineno-2-33></a>        <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
<a id=__codelineno-2-34 name=__codelineno-2-34 href=#__codelineno-2-34></a>        <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
<a id=__codelineno-2-35 name=__codelineno-2-35 href=#__codelineno-2-35></a>        <span class=n>comment</span><span class=o>=</span><span class=s2>&quot;When this pulse should execute (UTC timestamp)&quot;</span>
<a id=__codelineno-2-36 name=__codelineno-2-36 href=#__codelineno-2-36></a>    <span class=p>)</span>
<a id=__codelineno-2-37 name=__codelineno-2-37 href=#__codelineno-2-37></a>
<a id=__codelineno-2-38 name=__codelineno-2-38 href=#__codelineno-2-38></a>    <span class=c1># Execution Context</span>
<a id=__codelineno-2-39 name=__codelineno-2-39 href=#__codelineno-2-39></a>    <span class=n>prompt</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span>
<a id=__codelineno-2-40 name=__codelineno-2-40 href=#__codelineno-2-40></a>        <span class=n>Text</span><span class=p>,</span>
<a id=__codelineno-2-41 name=__codelineno-2-41 href=#__codelineno-2-41></a>        <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
<a id=__codelineno-2-42 name=__codelineno-2-42 href=#__codelineno-2-42></a>        <span class=n>comment</span><span class=o>=</span><span class=s2>&quot;The instruction/context for Reeve when this pulse fires. &quot;</span>
<a id=__codelineno-2-43 name=__codelineno-2-43 href=#__codelineno-2-43></a>                <span class=s2>&quot;This becomes the initial message in the Hapi session.&quot;</span>
<a id=__codelineno-2-44 name=__codelineno-2-44 href=#__codelineno-2-44></a>    <span class=p>)</span>
<a id=__codelineno-2-45 name=__codelineno-2-45 href=#__codelineno-2-45></a>
<a id=__codelineno-2-46 name=__codelineno-2-46 href=#__codelineno-2-46></a>    <span class=n>priority</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span>
<a id=__codelineno-2-47 name=__codelineno-2-47 href=#__codelineno-2-47></a>        <span class=n>SQLEnum</span><span class=p>(</span><span class=n>PulsePriority</span><span class=p>),</span>
<a id=__codelineno-2-48 name=__codelineno-2-48 href=#__codelineno-2-48></a>        <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
<a id=__codelineno-2-49 name=__codelineno-2-49 href=#__codelineno-2-49></a>        <span class=n>default</span><span class=o>=</span><span class=n>PulsePriority</span><span class=o>.</span><span class=n>NORMAL</span><span class=p>,</span>
<a id=__codelineno-2-50 name=__codelineno-2-50 href=#__codelineno-2-50></a>        <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
<a id=__codelineno-2-51 name=__codelineno-2-51 href=#__codelineno-2-51></a>        <span class=n>comment</span><span class=o>=</span><span class=s2>&quot;Execution priority (determines order when multiple pulses are due)&quot;</span>
<a id=__codelineno-2-52 name=__codelineno-2-52 href=#__codelineno-2-52></a>    <span class=p>)</span>
<a id=__codelineno-2-53 name=__codelineno-2-53 href=#__codelineno-2-53></a>
<a id=__codelineno-2-54 name=__codelineno-2-54 href=#__codelineno-2-54></a>    <span class=c1># Session Continuity (Optional)</span>
<a id=__codelineno-2-55 name=__codelineno-2-55 href=#__codelineno-2-55></a>    <span class=n>session_id</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span>
<a id=__codelineno-2-56 name=__codelineno-2-56 href=#__codelineno-2-56></a>        <span class=n>String</span><span class=p>(</span><span class=mi>500</span><span class=p>),</span>
<a id=__codelineno-2-57 name=__codelineno-2-57 href=#__codelineno-2-57></a>        <span class=n>nullable</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
<a id=__codelineno-2-58 name=__codelineno-2-58 href=#__codelineno-2-58></a>        <span class=n>comment</span><span class=o>=</span><span class=s2>&quot;Optional Hapi session ID or URL to resume existing context. &quot;</span>
<a id=__codelineno-2-59 name=__codelineno-2-59 href=#__codelineno-2-59></a>                <span class=s2>&quot;If None, a new session is created.&quot;</span>
<a id=__codelineno-2-60 name=__codelineno-2-60 href=#__codelineno-2-60></a>    <span class=p>)</span>
<a id=__codelineno-2-61 name=__codelineno-2-61 href=#__codelineno-2-61></a>
<a id=__codelineno-2-62 name=__codelineno-2-62 href=#__codelineno-2-62></a>    <span class=n>sticky_notes</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span>
<a id=__codelineno-2-63 name=__codelineno-2-63 href=#__codelineno-2-63></a>        <span class=n>JSON</span><span class=p>,</span>
<a id=__codelineno-2-64 name=__codelineno-2-64 href=#__codelineno-2-64></a>        <span class=n>nullable</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
<a id=__codelineno-2-65 name=__codelineno-2-65 href=#__codelineno-2-65></a>        <span class=n>comment</span><span class=o>=</span><span class=s2>&quot;Optional list of reminder strings to inject into the prompt. &quot;</span>
<a id=__codelineno-2-66 name=__codelineno-2-66 href=#__codelineno-2-66></a>                <span class=s2>&quot;Example: [&#39;Check if user replied to ski trip&#39;, &#39;Follow up on PR review&#39;]&quot;</span>
<a id=__codelineno-2-67 name=__codelineno-2-67 href=#__codelineno-2-67></a>    <span class=p>)</span>
<a id=__codelineno-2-68 name=__codelineno-2-68 href=#__codelineno-2-68></a>
<a id=__codelineno-2-69 name=__codelineno-2-69 href=#__codelineno-2-69></a>    <span class=c1># Execution State</span>
<a id=__codelineno-2-70 name=__codelineno-2-70 href=#__codelineno-2-70></a>    <span class=n>status</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span>
<a id=__codelineno-2-71 name=__codelineno-2-71 href=#__codelineno-2-71></a>        <span class=n>SQLEnum</span><span class=p>(</span><span class=n>PulseStatus</span><span class=p>),</span>
<a id=__codelineno-2-72 name=__codelineno-2-72 href=#__codelineno-2-72></a>        <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
<a id=__codelineno-2-73 name=__codelineno-2-73 href=#__codelineno-2-73></a>        <span class=n>default</span><span class=o>=</span><span class=n>PulseStatus</span><span class=o>.</span><span class=n>PENDING</span><span class=p>,</span>
<a id=__codelineno-2-74 name=__codelineno-2-74 href=#__codelineno-2-74></a>        <span class=n>index</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
<a id=__codelineno-2-75 name=__codelineno-2-75 href=#__codelineno-2-75></a>        <span class=n>comment</span><span class=o>=</span><span class=s2>&quot;Current execution status of this pulse&quot;</span>
<a id=__codelineno-2-76 name=__codelineno-2-76 href=#__codelineno-2-76></a>    <span class=p>)</span>
<a id=__codelineno-2-77 name=__codelineno-2-77 href=#__codelineno-2-77></a>
<a id=__codelineno-2-78 name=__codelineno-2-78 href=#__codelineno-2-78></a>    <span class=c1># Execution Results (populated after execution)</span>
<a id=__codelineno-2-79 name=__codelineno-2-79 href=#__codelineno-2-79></a>    <span class=n>executed_at</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span>
<a id=__codelineno-2-80 name=__codelineno-2-80 href=#__codelineno-2-80></a>        <span class=n>DateTime</span><span class=p>(</span><span class=n>timezone</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>
<a id=__codelineno-2-81 name=__codelineno-2-81 href=#__codelineno-2-81></a>        <span class=n>nullable</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
<a id=__codelineno-2-82 name=__codelineno-2-82 href=#__codelineno-2-82></a>        <span class=n>comment</span><span class=o>=</span><span class=s2>&quot;When this pulse actually executed (may differ from scheduled_at)&quot;</span>
<a id=__codelineno-2-83 name=__codelineno-2-83 href=#__codelineno-2-83></a>    <span class=p>)</span>
<a id=__codelineno-2-84 name=__codelineno-2-84 href=#__codelineno-2-84></a>
<a id=__codelineno-2-85 name=__codelineno-2-85 href=#__codelineno-2-85></a>    <span class=n>execution_duration_ms</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span>
<a id=__codelineno-2-86 name=__codelineno-2-86 href=#__codelineno-2-86></a>        <span class=n>Integer</span><span class=p>,</span>
<a id=__codelineno-2-87 name=__codelineno-2-87 href=#__codelineno-2-87></a>        <span class=n>nullable</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
<a id=__codelineno-2-88 name=__codelineno-2-88 href=#__codelineno-2-88></a>        <span class=n>comment</span><span class=o>=</span><span class=s2>&quot;How long the Hapi session took to complete (milliseconds)&quot;</span>
<a id=__codelineno-2-89 name=__codelineno-2-89 href=#__codelineno-2-89></a>    <span class=p>)</span>
<a id=__codelineno-2-90 name=__codelineno-2-90 href=#__codelineno-2-90></a>
<a id=__codelineno-2-91 name=__codelineno-2-91 href=#__codelineno-2-91></a>    <span class=n>error_message</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span>
<a id=__codelineno-2-92 name=__codelineno-2-92 href=#__codelineno-2-92></a>        <span class=n>Text</span><span class=p>,</span>
<a id=__codelineno-2-93 name=__codelineno-2-93 href=#__codelineno-2-93></a>        <span class=n>nullable</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
<a id=__codelineno-2-94 name=__codelineno-2-94 href=#__codelineno-2-94></a>        <span class=n>comment</span><span class=o>=</span><span class=s2>&quot;Error message if status=FAILED. Used for debugging and retry logic.&quot;</span>
<a id=__codelineno-2-95 name=__codelineno-2-95 href=#__codelineno-2-95></a>    <span class=p>)</span>
<a id=__codelineno-2-96 name=__codelineno-2-96 href=#__codelineno-2-96></a>
<a id=__codelineno-2-97 name=__codelineno-2-97 href=#__codelineno-2-97></a>    <span class=c1># Retry Logic</span>
<a id=__codelineno-2-98 name=__codelineno-2-98 href=#__codelineno-2-98></a>    <span class=n>retry_count</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span>
<a id=__codelineno-2-99 name=__codelineno-2-99 href=#__codelineno-2-99></a>        <span class=n>Integer</span><span class=p>,</span>
<a id=__codelineno-2-100 name=__codelineno-2-100 href=#__codelineno-2-100></a>        <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
<a id=__codelineno-2-101 name=__codelineno-2-101 href=#__codelineno-2-101></a>        <span class=n>default</span><span class=o>=</span><span class=mi>0</span><span class=p>,</span>
<a id=__codelineno-2-102 name=__codelineno-2-102 href=#__codelineno-2-102></a>        <span class=n>comment</span><span class=o>=</span><span class=s2>&quot;Number of times this pulse has been retried after failure&quot;</span>
<a id=__codelineno-2-103 name=__codelineno-2-103 href=#__codelineno-2-103></a>    <span class=p>)</span>
<a id=__codelineno-2-104 name=__codelineno-2-104 href=#__codelineno-2-104></a>
<a id=__codelineno-2-105 name=__codelineno-2-105 href=#__codelineno-2-105></a>    <span class=n>max_retries</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span>
<a id=__codelineno-2-106 name=__codelineno-2-106 href=#__codelineno-2-106></a>        <span class=n>Integer</span><span class=p>,</span>
<a id=__codelineno-2-107 name=__codelineno-2-107 href=#__codelineno-2-107></a>        <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
<a id=__codelineno-2-108 name=__codelineno-2-108 href=#__codelineno-2-108></a>        <span class=n>default</span><span class=o>=</span><span class=mi>3</span><span class=p>,</span>
<a id=__codelineno-2-109 name=__codelineno-2-109 href=#__codelineno-2-109></a>        <span class=n>comment</span><span class=o>=</span><span class=s2>&quot;Maximum retry attempts before giving up&quot;</span>
<a id=__codelineno-2-110 name=__codelineno-2-110 href=#__codelineno-2-110></a>    <span class=p>)</span>
<a id=__codelineno-2-111 name=__codelineno-2-111 href=#__codelineno-2-111></a>
<a id=__codelineno-2-112 name=__codelineno-2-112 href=#__codelineno-2-112></a>    <span class=c1># Metadata</span>
<a id=__codelineno-2-113 name=__codelineno-2-113 href=#__codelineno-2-113></a>    <span class=n>created_at</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span>
<a id=__codelineno-2-114 name=__codelineno-2-114 href=#__codelineno-2-114></a>        <span class=n>DateTime</span><span class=p>(</span><span class=n>timezone</span><span class=o>=</span><span class=kc>True</span><span class=p>),</span>
<a id=__codelineno-2-115 name=__codelineno-2-115 href=#__codelineno-2-115></a>        <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
<a id=__codelineno-2-116 name=__codelineno-2-116 href=#__codelineno-2-116></a>        <span class=n>server_default</span><span class=o>=</span><span class=n>func</span><span class=o>.</span><span class=n>now</span><span class=p>(),</span>
<a id=__codelineno-2-117 name=__codelineno-2-117 href=#__codelineno-2-117></a>        <span class=n>comment</span><span class=o>=</span><span class=s2>&quot;When this pulse was created (for auditing)&quot;</span>
<a id=__codelineno-2-118 name=__codelineno-2-118 href=#__codelineno-2-118></a>    <span class=p>)</span>
<a id=__codelineno-2-119 name=__codelineno-2-119 href=#__codelineno-2-119></a>
<a id=__codelineno-2-120 name=__codelineno-2-120 href=#__codelineno-2-120></a>    <span class=n>created_by</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span>
<a id=__codelineno-2-121 name=__codelineno-2-121 href=#__codelineno-2-121></a>        <span class=n>String</span><span class=p>(</span><span class=mi>100</span><span class=p>),</span>
<a id=__codelineno-2-122 name=__codelineno-2-122 href=#__codelineno-2-122></a>        <span class=n>nullable</span><span class=o>=</span><span class=kc>False</span><span class=p>,</span>
<a id=__codelineno-2-123 name=__codelineno-2-123 href=#__codelineno-2-123></a>        <span class=n>default</span><span class=o>=</span><span class=s2>&quot;system&quot;</span><span class=p>,</span>
<a id=__codelineno-2-124 name=__codelineno-2-124 href=#__codelineno-2-124></a>        <span class=n>comment</span><span class=o>=</span><span class=s2>&quot;Who/what created this pulse. Examples: &#39;reeve&#39;, &#39;telegram_listener&#39;, &#39;user_cli&#39;&quot;</span>
<a id=__codelineno-2-125 name=__codelineno-2-125 href=#__codelineno-2-125></a>    <span class=p>)</span>
<a id=__codelineno-2-126 name=__codelineno-2-126 href=#__codelineno-2-126></a>
<a id=__codelineno-2-127 name=__codelineno-2-127 href=#__codelineno-2-127></a>    <span class=n>tags</span> <span class=o>=</span> <span class=n>Column</span><span class=p>(</span>
<a id=__codelineno-2-128 name=__codelineno-2-128 href=#__codelineno-2-128></a>        <span class=n>JSON</span><span class=p>,</span>
<a id=__codelineno-2-129 name=__codelineno-2-129 href=#__codelineno-2-129></a>        <span class=n>nullable</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
<a id=__codelineno-2-130 name=__codelineno-2-130 href=#__codelineno-2-130></a>        <span class=n>comment</span><span class=o>=</span><span class=s2>&quot;Optional tags for categorization/filtering. &quot;</span>
<a id=__codelineno-2-131 name=__codelineno-2-131 href=#__codelineno-2-131></a>                <span class=s2>&quot;Example: [&#39;hourly_check&#39;, &#39;calendar_sync&#39;, &#39;snowboarding&#39;]&quot;</span>
<a id=__codelineno-2-132 name=__codelineno-2-132 href=#__codelineno-2-132></a>    <span class=p>)</span>
<a id=__codelineno-2-133 name=__codelineno-2-133 href=#__codelineno-2-133></a>
<a id=__codelineno-2-134 name=__codelineno-2-134 href=#__codelineno-2-134></a>    <span class=c1># Database Indexes (in addition to individual column indexes)</span>
<a id=__codelineno-2-135 name=__codelineno-2-135 href=#__codelineno-2-135></a>    <span class=c1># Composite index for the main query pattern</span>
<a id=__codelineno-2-136 name=__codelineno-2-136 href=#__codelineno-2-136></a>    <span class=n>__table_args__</span> <span class=o>=</span> <span class=p>(</span>
<a id=__codelineno-2-137 name=__codelineno-2-137 href=#__codelineno-2-137></a>        <span class=c1># Most common query: &quot;Get all pending/processing pulses due before now, ordered by priority&quot;</span>
<a id=__codelineno-2-138 name=__codelineno-2-138 href=#__codelineno-2-138></a>        <span class=n>Index</span><span class=p>(</span><span class=s1>&#39;idx_pulse_execution&#39;</span><span class=p>,</span> <span class=s1>&#39;status&#39;</span><span class=p>,</span> <span class=s1>&#39;scheduled_at&#39;</span><span class=p>,</span> <span class=s1>&#39;priority&#39;</span><span class=p>),</span>
<a id=__codelineno-2-139 name=__codelineno-2-139 href=#__codelineno-2-139></a>        <span class=c1># For listing upcoming pulses: &quot;What&#39;s on Reeve&#39;s schedule?&quot;</span>
<a id=__codelineno-2-140 name=__codelineno-2-140 href=#__codelineno-2-140></a>        <span class=n>Index</span><span class=p>(</span><span class=s1>&#39;idx_pulse_upcoming&#39;</span><span class=p>,</span> <span class=s1>&#39;scheduled_at&#39;</span><span class=p>,</span> <span class=s1>&#39;status&#39;</span><span class=p>),</span>
<a id=__codelineno-2-141 name=__codelineno-2-141 href=#__codelineno-2-141></a>    <span class=p>)</span>
<a id=__codelineno-2-142 name=__codelineno-2-142 href=#__codelineno-2-142></a>
<a id=__codelineno-2-143 name=__codelineno-2-143 href=#__codelineno-2-143></a>    <span class=k>def</span><span class=w> </span><span class=fm>__repr__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<a id=__codelineno-2-144 name=__codelineno-2-144 href=#__codelineno-2-144></a>        <span class=k>return</span> <span class=p>(</span><span class=sa>f</span><span class=s2>&quot;&lt;Pulse(id=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>id</span><span class=si>}</span><span class=s2>, scheduled_at=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>scheduled_at</span><span class=si>}</span><span class=s2>, &quot;</span>
<a id=__codelineno-2-145 name=__codelineno-2-145 href=#__codelineno-2-145></a>                <span class=sa>f</span><span class=s2>&quot;priority=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>priority</span><span class=o>.</span><span class=n>value</span><span class=si>}</span><span class=s2>, status=</span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>status</span><span class=o>.</span><span class=n>value</span><span class=si>}</span><span class=s2>)&gt;&quot;</span><span class=p>)</span>
</code></pre></div> <h3 id=alembic-migration-strategy>Alembic Migration Strategy<a class=headerlink href=#alembic-migration-strategy title="Permanent link">&para;</a></h3> <p><strong>Initial Migration</strong> (<code>versions/001_create_pulses_table.py</code>): <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=sd>&quot;&quot;&quot;Create pulses table</span>
<a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a>
<a id=__codelineno-3-3 name=__codelineno-3-3 href=#__codelineno-3-3></a><span class=sd>Revision ID: 001</span>
<a id=__codelineno-3-4 name=__codelineno-3-4 href=#__codelineno-3-4></a><span class=sd>Revises:</span>
<a id=__codelineno-3-5 name=__codelineno-3-5 href=#__codelineno-3-5></a><span class=sd>Create Date: 2026-01-19</span>
<a id=__codelineno-3-6 name=__codelineno-3-6 href=#__codelineno-3-6></a><span class=sd>&quot;&quot;&quot;</span>
<a id=__codelineno-3-7 name=__codelineno-3-7 href=#__codelineno-3-7></a><span class=kn>from</span><span class=w> </span><span class=nn>alembic</span><span class=w> </span><span class=kn>import</span> <span class=n>op</span>
<a id=__codelineno-3-8 name=__codelineno-3-8 href=#__codelineno-3-8></a><span class=kn>import</span><span class=w> </span><span class=nn>sqlalchemy</span><span class=w> </span><span class=k>as</span><span class=w> </span><span class=nn>sa</span>
<a id=__codelineno-3-9 name=__codelineno-3-9 href=#__codelineno-3-9></a><span class=kn>from</span><span class=w> </span><span class=nn>sqlalchemy.dialects</span><span class=w> </span><span class=kn>import</span> <span class=n>sqlite</span>
<a id=__codelineno-3-10 name=__codelineno-3-10 href=#__codelineno-3-10></a>
<a id=__codelineno-3-11 name=__codelineno-3-11 href=#__codelineno-3-11></a><span class=n>revision</span> <span class=o>=</span> <span class=s1>&#39;001&#39;</span>
<a id=__codelineno-3-12 name=__codelineno-3-12 href=#__codelineno-3-12></a><span class=n>down_revision</span> <span class=o>=</span> <span class=kc>None</span>
<a id=__codelineno-3-13 name=__codelineno-3-13 href=#__codelineno-3-13></a><span class=n>branch_labels</span> <span class=o>=</span> <span class=kc>None</span>
<a id=__codelineno-3-14 name=__codelineno-3-14 href=#__codelineno-3-14></a><span class=n>depends_on</span> <span class=o>=</span> <span class=kc>None</span>
<a id=__codelineno-3-15 name=__codelineno-3-15 href=#__codelineno-3-15></a>
<a id=__codelineno-3-16 name=__codelineno-3-16 href=#__codelineno-3-16></a><span class=k>def</span><span class=w> </span><span class=nf>upgrade</span><span class=p>():</span>
<a id=__codelineno-3-17 name=__codelineno-3-17 href=#__codelineno-3-17></a>    <span class=n>op</span><span class=o>.</span><span class=n>create_table</span><span class=p>(</span>
<a id=__codelineno-3-18 name=__codelineno-3-18 href=#__codelineno-3-18></a>        <span class=s1>&#39;pulses&#39;</span><span class=p>,</span>
<a id=__codelineno-3-19 name=__codelineno-3-19 href=#__codelineno-3-19></a>        <span class=c1># ... (full schema as defined above)</span>
<a id=__codelineno-3-20 name=__codelineno-3-20 href=#__codelineno-3-20></a>    <span class=p>)</span>
<a id=__codelineno-3-21 name=__codelineno-3-21 href=#__codelineno-3-21></a>
<a id=__codelineno-3-22 name=__codelineno-3-22 href=#__codelineno-3-22></a><span class=k>def</span><span class=w> </span><span class=nf>downgrade</span><span class=p>():</span>
<a id=__codelineno-3-23 name=__codelineno-3-23 href=#__codelineno-3-23></a>    <span class=n>op</span><span class=o>.</span><span class=n>drop_table</span><span class=p>(</span><span class=s1>&#39;pulses&#39;</span><span class=p>)</span>
</code></pre></div></p> <p><strong>Why Alembic?</strong> - Version-controlled schema changes - Safe migrations in production - Rollback capability - Explicit upgrade path</p> <h2 id=queue-management-logic>Queue Management Logic<a class=headerlink href=#queue-management-logic title="Permanent link">&para;</a></h2> <h3 id=pulsequeue-class>PulseQueue Class<a class=headerlink href=#pulsequeue-class title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=kn>from</span><span class=w> </span><span class=nn>sqlalchemy.ext.asyncio</span><span class=w> </span><span class=kn>import</span> <span class=n>AsyncSession</span><span class=p>,</span> <span class=n>create_async_engine</span><span class=p>,</span> <span class=n>async_sessionmaker</span>
<a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=kn>from</span><span class=w> </span><span class=nn>sqlalchemy</span><span class=w> </span><span class=kn>import</span> <span class=n>select</span><span class=p>,</span> <span class=n>and_</span><span class=p>,</span> <span class=n>or_</span>
<a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a><span class=kn>from</span><span class=w> </span><span class=nn>datetime</span><span class=w> </span><span class=kn>import</span> <span class=n>datetime</span><span class=p>,</span> <span class=n>timezone</span>
<a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=kn>from</span><span class=w> </span><span class=nn>typing</span><span class=w> </span><span class=kn>import</span> <span class=n>List</span><span class=p>,</span> <span class=n>Optional</span>
<a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=kn>import</span><span class=w> </span><span class=nn>asyncio</span>
<a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>
<a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=k>class</span><span class=w> </span><span class=nc>PulseQueue</span><span class=p>:</span>
<a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a><span class=w>    </span><span class=sd>&quot;&quot;&quot;</span>
<a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=sd>    Manages the pulse queue: scheduling, retrieval, and execution tracking.</span>
<a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>
<a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=sd>    This is the core business logic layer for pulse management. It provides</span>
<a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a><span class=sd>    a clean API for the MCP server, HTTP API, and daemon scheduler to interact</span>
<a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=sd>    with the queue.</span>
<a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a>
<a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=sd>    All database operations are async to support high concurrency.</span>
<a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a><span class=sd>    &quot;&quot;&quot;</span>
<a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a>
<a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a>    <span class=k>def</span><span class=w> </span><span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>db_url</span><span class=p>:</span> <span class=nb>str</span><span class=p>):</span>
<a id=__codelineno-4-19 name=__codelineno-4-19 href=#__codelineno-4-19></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<a id=__codelineno-4-20 name=__codelineno-4-20 href=#__codelineno-4-20></a><span class=sd>        Initialize the pulse queue with a database connection.</span>
<a id=__codelineno-4-21 name=__codelineno-4-21 href=#__codelineno-4-21></a>
<a id=__codelineno-4-22 name=__codelineno-4-22 href=#__codelineno-4-22></a><span class=sd>        Args:</span>
<a id=__codelineno-4-23 name=__codelineno-4-23 href=#__codelineno-4-23></a><span class=sd>            db_url: SQLAlchemy database URL. Examples:</span>
<a id=__codelineno-4-24 name=__codelineno-4-24 href=#__codelineno-4-24></a><span class=sd>                - &quot;sqlite+aiosqlite:///~/.reeve/pulse_queue.db&quot; (async SQLite)</span>
<a id=__codelineno-4-25 name=__codelineno-4-25 href=#__codelineno-4-25></a><span class=sd>                - &quot;postgresql+asyncpg://user:pass@localhost/reeve&quot; (async Postgres)</span>
<a id=__codelineno-4-26 name=__codelineno-4-26 href=#__codelineno-4-26></a><span class=sd>        &quot;&quot;&quot;</span>
<a id=__codelineno-4-27 name=__codelineno-4-27 href=#__codelineno-4-27></a>        <span class=bp>self</span><span class=o>.</span><span class=n>engine</span> <span class=o>=</span> <span class=n>create_async_engine</span><span class=p>(</span><span class=n>db_url</span><span class=p>,</span> <span class=n>echo</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
<a id=__codelineno-4-28 name=__codelineno-4-28 href=#__codelineno-4-28></a>        <span class=bp>self</span><span class=o>.</span><span class=n>SessionLocal</span> <span class=o>=</span> <span class=n>async_sessionmaker</span><span class=p>(</span>
<a id=__codelineno-4-29 name=__codelineno-4-29 href=#__codelineno-4-29></a>            <span class=bp>self</span><span class=o>.</span><span class=n>engine</span><span class=p>,</span>
<a id=__codelineno-4-30 name=__codelineno-4-30 href=#__codelineno-4-30></a>            <span class=n>class_</span><span class=o>=</span><span class=n>AsyncSession</span><span class=p>,</span>
<a id=__codelineno-4-31 name=__codelineno-4-31 href=#__codelineno-4-31></a>            <span class=n>expire_on_commit</span><span class=o>=</span><span class=kc>False</span>
<a id=__codelineno-4-32 name=__codelineno-4-32 href=#__codelineno-4-32></a>        <span class=p>)</span>
<a id=__codelineno-4-33 name=__codelineno-4-33 href=#__codelineno-4-33></a>
<a id=__codelineno-4-34 name=__codelineno-4-34 href=#__codelineno-4-34></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>schedule_pulse</span><span class=p>(</span>
<a id=__codelineno-4-35 name=__codelineno-4-35 href=#__codelineno-4-35></a>        <span class=bp>self</span><span class=p>,</span>
<a id=__codelineno-4-36 name=__codelineno-4-36 href=#__codelineno-4-36></a>        <span class=n>scheduled_at</span><span class=p>:</span> <span class=n>datetime</span><span class=p>,</span>
<a id=__codelineno-4-37 name=__codelineno-4-37 href=#__codelineno-4-37></a>        <span class=n>prompt</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
<a id=__codelineno-4-38 name=__codelineno-4-38 href=#__codelineno-4-38></a>        <span class=n>priority</span><span class=p>:</span> <span class=n>PulsePriority</span> <span class=o>=</span> <span class=n>PulsePriority</span><span class=o>.</span><span class=n>NORMAL</span><span class=p>,</span>
<a id=__codelineno-4-39 name=__codelineno-4-39 href=#__codelineno-4-39></a>        <span class=n>session_id</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>str</span><span class=p>]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
<a id=__codelineno-4-40 name=__codelineno-4-40 href=#__codelineno-4-40></a>        <span class=n>sticky_notes</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
<a id=__codelineno-4-41 name=__codelineno-4-41 href=#__codelineno-4-41></a>        <span class=n>tags</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=nb>str</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span><span class=p>,</span>
<a id=__codelineno-4-42 name=__codelineno-4-42 href=#__codelineno-4-42></a>        <span class=n>created_by</span><span class=p>:</span> <span class=nb>str</span> <span class=o>=</span> <span class=s2>&quot;system&quot;</span><span class=p>,</span>
<a id=__codelineno-4-43 name=__codelineno-4-43 href=#__codelineno-4-43></a>        <span class=n>max_retries</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>3</span>
<a id=__codelineno-4-44 name=__codelineno-4-44 href=#__codelineno-4-44></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>int</span><span class=p>:</span>
<a id=__codelineno-4-45 name=__codelineno-4-45 href=#__codelineno-4-45></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<a id=__codelineno-4-46 name=__codelineno-4-46 href=#__codelineno-4-46></a><span class=sd>        Schedule a new pulse.</span>
<a id=__codelineno-4-47 name=__codelineno-4-47 href=#__codelineno-4-47></a>
<a id=__codelineno-4-48 name=__codelineno-4-48 href=#__codelineno-4-48></a><span class=sd>        Args:</span>
<a id=__codelineno-4-49 name=__codelineno-4-49 href=#__codelineno-4-49></a><span class=sd>            scheduled_at: When to execute (UTC timezone-aware datetime)</span>
<a id=__codelineno-4-50 name=__codelineno-4-50 href=#__codelineno-4-50></a><span class=sd>            prompt: The instruction/context for Reeve</span>
<a id=__codelineno-4-51 name=__codelineno-4-51 href=#__codelineno-4-51></a><span class=sd>            priority: Urgency level (default: NORMAL)</span>
<a id=__codelineno-4-52 name=__codelineno-4-52 href=#__codelineno-4-52></a><span class=sd>            session_id: Optional Hapi session to resume</span>
<a id=__codelineno-4-53 name=__codelineno-4-53 href=#__codelineno-4-53></a><span class=sd>            sticky_notes: Optional reminder strings to inject</span>
<a id=__codelineno-4-54 name=__codelineno-4-54 href=#__codelineno-4-54></a><span class=sd>            tags: Optional categorization tags</span>
<a id=__codelineno-4-55 name=__codelineno-4-55 href=#__codelineno-4-55></a><span class=sd>            created_by: Who created this pulse (for auditing)</span>
<a id=__codelineno-4-56 name=__codelineno-4-56 href=#__codelineno-4-56></a><span class=sd>            max_retries: Max retry attempts on failure</span>
<a id=__codelineno-4-57 name=__codelineno-4-57 href=#__codelineno-4-57></a>
<a id=__codelineno-4-58 name=__codelineno-4-58 href=#__codelineno-4-58></a><span class=sd>        Returns:</span>
<a id=__codelineno-4-59 name=__codelineno-4-59 href=#__codelineno-4-59></a><span class=sd>            The pulse ID (integer)</span>
<a id=__codelineno-4-60 name=__codelineno-4-60 href=#__codelineno-4-60></a>
<a id=__codelineno-4-61 name=__codelineno-4-61 href=#__codelineno-4-61></a><span class=sd>        Example:</span>
<a id=__codelineno-4-62 name=__codelineno-4-62 href=#__codelineno-4-62></a><span class=sd>            pulse_id = await queue.schedule_pulse(</span>
<a id=__codelineno-4-63 name=__codelineno-4-63 href=#__codelineno-4-63></a><span class=sd>                scheduled_at=datetime(2026, 1, 20, 9, 0, tzinfo=timezone.utc),</span>
<a id=__codelineno-4-64 name=__codelineno-4-64 href=#__codelineno-4-64></a><span class=sd>                prompt=&quot;Daily morning briefing: Review calendar and tasks&quot;,</span>
<a id=__codelineno-4-65 name=__codelineno-4-65 href=#__codelineno-4-65></a><span class=sd>                priority=PulsePriority.NORMAL,</span>
<a id=__codelineno-4-66 name=__codelineno-4-66 href=#__codelineno-4-66></a><span class=sd>                tags=[&quot;daily&quot;, &quot;morning_routine&quot;]</span>
<a id=__codelineno-4-67 name=__codelineno-4-67 href=#__codelineno-4-67></a><span class=sd>            )</span>
<a id=__codelineno-4-68 name=__codelineno-4-68 href=#__codelineno-4-68></a><span class=sd>        &quot;&quot;&quot;</span>
<a id=__codelineno-4-69 name=__codelineno-4-69 href=#__codelineno-4-69></a>        <span class=k>async</span> <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>SessionLocal</span><span class=p>()</span> <span class=k>as</span> <span class=n>session</span><span class=p>:</span>
<a id=__codelineno-4-70 name=__codelineno-4-70 href=#__codelineno-4-70></a>            <span class=n>pulse</span> <span class=o>=</span> <span class=n>Pulse</span><span class=p>(</span>
<a id=__codelineno-4-71 name=__codelineno-4-71 href=#__codelineno-4-71></a>                <span class=n>scheduled_at</span><span class=o>=</span><span class=n>scheduled_at</span><span class=p>,</span>
<a id=__codelineno-4-72 name=__codelineno-4-72 href=#__codelineno-4-72></a>                <span class=n>prompt</span><span class=o>=</span><span class=n>prompt</span><span class=p>,</span>
<a id=__codelineno-4-73 name=__codelineno-4-73 href=#__codelineno-4-73></a>                <span class=n>priority</span><span class=o>=</span><span class=n>priority</span><span class=p>,</span>
<a id=__codelineno-4-74 name=__codelineno-4-74 href=#__codelineno-4-74></a>                <span class=n>session_id</span><span class=o>=</span><span class=n>session_id</span><span class=p>,</span>
<a id=__codelineno-4-75 name=__codelineno-4-75 href=#__codelineno-4-75></a>                <span class=n>sticky_notes</span><span class=o>=</span><span class=n>sticky_notes</span><span class=p>,</span>
<a id=__codelineno-4-76 name=__codelineno-4-76 href=#__codelineno-4-76></a>                <span class=n>tags</span><span class=o>=</span><span class=n>tags</span><span class=p>,</span>
<a id=__codelineno-4-77 name=__codelineno-4-77 href=#__codelineno-4-77></a>                <span class=n>created_by</span><span class=o>=</span><span class=n>created_by</span><span class=p>,</span>
<a id=__codelineno-4-78 name=__codelineno-4-78 href=#__codelineno-4-78></a>                <span class=n>max_retries</span><span class=o>=</span><span class=n>max_retries</span><span class=p>,</span>
<a id=__codelineno-4-79 name=__codelineno-4-79 href=#__codelineno-4-79></a>                <span class=n>status</span><span class=o>=</span><span class=n>PulseStatus</span><span class=o>.</span><span class=n>PENDING</span>
<a id=__codelineno-4-80 name=__codelineno-4-80 href=#__codelineno-4-80></a>            <span class=p>)</span>
<a id=__codelineno-4-81 name=__codelineno-4-81 href=#__codelineno-4-81></a>            <span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>pulse</span><span class=p>)</span>
<a id=__codelineno-4-82 name=__codelineno-4-82 href=#__codelineno-4-82></a>            <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
<a id=__codelineno-4-83 name=__codelineno-4-83 href=#__codelineno-4-83></a>            <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>refresh</span><span class=p>(</span><span class=n>pulse</span><span class=p>)</span>
<a id=__codelineno-4-84 name=__codelineno-4-84 href=#__codelineno-4-84></a>            <span class=k>return</span> <span class=n>pulse</span><span class=o>.</span><span class=n>id</span>
<a id=__codelineno-4-85 name=__codelineno-4-85 href=#__codelineno-4-85></a>
<a id=__codelineno-4-86 name=__codelineno-4-86 href=#__codelineno-4-86></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>get_due_pulses</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>limit</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>10</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Pulse</span><span class=p>]:</span>
<a id=__codelineno-4-87 name=__codelineno-4-87 href=#__codelineno-4-87></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<a id=__codelineno-4-88 name=__codelineno-4-88 href=#__codelineno-4-88></a><span class=sd>        Get pulses that are due for execution.</span>
<a id=__codelineno-4-89 name=__codelineno-4-89 href=#__codelineno-4-89></a>
<a id=__codelineno-4-90 name=__codelineno-4-90 href=#__codelineno-4-90></a><span class=sd>        Returns pulses where:</span>
<a id=__codelineno-4-91 name=__codelineno-4-91 href=#__codelineno-4-91></a><span class=sd>        - scheduled_at &lt;= now</span>
<a id=__codelineno-4-92 name=__codelineno-4-92 href=#__codelineno-4-92></a><span class=sd>        - status = PENDING</span>
<a id=__codelineno-4-93 name=__codelineno-4-93 href=#__codelineno-4-93></a><span class=sd>        - Ordered by: priority DESC, scheduled_at ASC</span>
<a id=__codelineno-4-94 name=__codelineno-4-94 href=#__codelineno-4-94></a>
<a id=__codelineno-4-95 name=__codelineno-4-95 href=#__codelineno-4-95></a><span class=sd>        This ensures high-priority pulses execute first, and among same-priority</span>
<a id=__codelineno-4-96 name=__codelineno-4-96 href=#__codelineno-4-96></a><span class=sd>        pulses, older ones execute first (FIFO).</span>
<a id=__codelineno-4-97 name=__codelineno-4-97 href=#__codelineno-4-97></a>
<a id=__codelineno-4-98 name=__codelineno-4-98 href=#__codelineno-4-98></a><span class=sd>        Args:</span>
<a id=__codelineno-4-99 name=__codelineno-4-99 href=#__codelineno-4-99></a><span class=sd>            limit: Maximum number of pulses to return</span>
<a id=__codelineno-4-100 name=__codelineno-4-100 href=#__codelineno-4-100></a>
<a id=__codelineno-4-101 name=__codelineno-4-101 href=#__codelineno-4-101></a><span class=sd>        Returns:</span>
<a id=__codelineno-4-102 name=__codelineno-4-102 href=#__codelineno-4-102></a><span class=sd>            List of Pulse objects ready for execution</span>
<a id=__codelineno-4-103 name=__codelineno-4-103 href=#__codelineno-4-103></a><span class=sd>        &quot;&quot;&quot;</span>
<a id=__codelineno-4-104 name=__codelineno-4-104 href=#__codelineno-4-104></a>        <span class=k>async</span> <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>SessionLocal</span><span class=p>()</span> <span class=k>as</span> <span class=n>session</span><span class=p>:</span>
<a id=__codelineno-4-105 name=__codelineno-4-105 href=#__codelineno-4-105></a>            <span class=n>now</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(</span><span class=n>timezone</span><span class=o>.</span><span class=n>utc</span><span class=p>)</span>
<a id=__codelineno-4-106 name=__codelineno-4-106 href=#__codelineno-4-106></a>
<a id=__codelineno-4-107 name=__codelineno-4-107 href=#__codelineno-4-107></a>            <span class=n>stmt</span> <span class=o>=</span> <span class=p>(</span>
<a id=__codelineno-4-108 name=__codelineno-4-108 href=#__codelineno-4-108></a>                <span class=n>select</span><span class=p>(</span><span class=n>Pulse</span><span class=p>)</span>
<a id=__codelineno-4-109 name=__codelineno-4-109 href=#__codelineno-4-109></a>                <span class=o>.</span><span class=n>where</span><span class=p>(</span>
<a id=__codelineno-4-110 name=__codelineno-4-110 href=#__codelineno-4-110></a>                    <span class=n>and_</span><span class=p>(</span>
<a id=__codelineno-4-111 name=__codelineno-4-111 href=#__codelineno-4-111></a>                        <span class=n>Pulse</span><span class=o>.</span><span class=n>scheduled_at</span> <span class=o>&lt;=</span> <span class=n>now</span><span class=p>,</span>
<a id=__codelineno-4-112 name=__codelineno-4-112 href=#__codelineno-4-112></a>                        <span class=n>Pulse</span><span class=o>.</span><span class=n>status</span> <span class=o>==</span> <span class=n>PulseStatus</span><span class=o>.</span><span class=n>PENDING</span>
<a id=__codelineno-4-113 name=__codelineno-4-113 href=#__codelineno-4-113></a>                    <span class=p>)</span>
<a id=__codelineno-4-114 name=__codelineno-4-114 href=#__codelineno-4-114></a>                <span class=p>)</span>
<a id=__codelineno-4-115 name=__codelineno-4-115 href=#__codelineno-4-115></a>                <span class=o>.</span><span class=n>order_by</span><span class=p>(</span>
<a id=__codelineno-4-116 name=__codelineno-4-116 href=#__codelineno-4-116></a>                    <span class=c1># Sort by priority enum value order (CRITICAL first)</span>
<a id=__codelineno-4-117 name=__codelineno-4-117 href=#__codelineno-4-117></a>                    <span class=n>Pulse</span><span class=o>.</span><span class=n>priority</span><span class=p>,</span>
<a id=__codelineno-4-118 name=__codelineno-4-118 href=#__codelineno-4-118></a>                    <span class=c1># Then by time (oldest first)</span>
<a id=__codelineno-4-119 name=__codelineno-4-119 href=#__codelineno-4-119></a>                    <span class=n>Pulse</span><span class=o>.</span><span class=n>scheduled_at</span>
<a id=__codelineno-4-120 name=__codelineno-4-120 href=#__codelineno-4-120></a>                <span class=p>)</span>
<a id=__codelineno-4-121 name=__codelineno-4-121 href=#__codelineno-4-121></a>                <span class=o>.</span><span class=n>limit</span><span class=p>(</span><span class=n>limit</span><span class=p>)</span>
<a id=__codelineno-4-122 name=__codelineno-4-122 href=#__codelineno-4-122></a>            <span class=p>)</span>
<a id=__codelineno-4-123 name=__codelineno-4-123 href=#__codelineno-4-123></a>
<a id=__codelineno-4-124 name=__codelineno-4-124 href=#__codelineno-4-124></a>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>stmt</span><span class=p>)</span>
<a id=__codelineno-4-125 name=__codelineno-4-125 href=#__codelineno-4-125></a>            <span class=k>return</span> <span class=nb>list</span><span class=p>(</span><span class=n>result</span><span class=o>.</span><span class=n>scalars</span><span class=p>()</span><span class=o>.</span><span class=n>all</span><span class=p>())</span>
<a id=__codelineno-4-126 name=__codelineno-4-126 href=#__codelineno-4-126></a>
<a id=__codelineno-4-127 name=__codelineno-4-127 href=#__codelineno-4-127></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>get_upcoming_pulses</span><span class=p>(</span>
<a id=__codelineno-4-128 name=__codelineno-4-128 href=#__codelineno-4-128></a>        <span class=bp>self</span><span class=p>,</span>
<a id=__codelineno-4-129 name=__codelineno-4-129 href=#__codelineno-4-129></a>        <span class=n>limit</span><span class=p>:</span> <span class=nb>int</span> <span class=o>=</span> <span class=mi>20</span><span class=p>,</span>
<a id=__codelineno-4-130 name=__codelineno-4-130 href=#__codelineno-4-130></a>        <span class=n>include_statuses</span><span class=p>:</span> <span class=n>Optional</span><span class=p>[</span><span class=n>List</span><span class=p>[</span><span class=n>PulseStatus</span><span class=p>]]</span> <span class=o>=</span> <span class=kc>None</span>
<a id=__codelineno-4-131 name=__codelineno-4-131 href=#__codelineno-4-131></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>List</span><span class=p>[</span><span class=n>Pulse</span><span class=p>]:</span>
<a id=__codelineno-4-132 name=__codelineno-4-132 href=#__codelineno-4-132></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<a id=__codelineno-4-133 name=__codelineno-4-133 href=#__codelineno-4-133></a><span class=sd>        Get upcoming scheduled pulses (for visibility/introspection).</span>
<a id=__codelineno-4-134 name=__codelineno-4-134 href=#__codelineno-4-134></a>
<a id=__codelineno-4-135 name=__codelineno-4-135 href=#__codelineno-4-135></a><span class=sd>        Args:</span>
<a id=__codelineno-4-136 name=__codelineno-4-136 href=#__codelineno-4-136></a><span class=sd>            limit: Maximum number of pulses to return</span>
<a id=__codelineno-4-137 name=__codelineno-4-137 href=#__codelineno-4-137></a><span class=sd>            include_statuses: Filter by status (default: [PENDING])</span>
<a id=__codelineno-4-138 name=__codelineno-4-138 href=#__codelineno-4-138></a>
<a id=__codelineno-4-139 name=__codelineno-4-139 href=#__codelineno-4-139></a><span class=sd>        Returns:</span>
<a id=__codelineno-4-140 name=__codelineno-4-140 href=#__codelineno-4-140></a><span class=sd>            List of Pulse objects ordered by scheduled_at</span>
<a id=__codelineno-4-141 name=__codelineno-4-141 href=#__codelineno-4-141></a><span class=sd>        &quot;&quot;&quot;</span>
<a id=__codelineno-4-142 name=__codelineno-4-142 href=#__codelineno-4-142></a>        <span class=k>if</span> <span class=n>include_statuses</span> <span class=ow>is</span> <span class=kc>None</span><span class=p>:</span>
<a id=__codelineno-4-143 name=__codelineno-4-143 href=#__codelineno-4-143></a>            <span class=n>include_statuses</span> <span class=o>=</span> <span class=p>[</span><span class=n>PulseStatus</span><span class=o>.</span><span class=n>PENDING</span><span class=p>]</span>
<a id=__codelineno-4-144 name=__codelineno-4-144 href=#__codelineno-4-144></a>
<a id=__codelineno-4-145 name=__codelineno-4-145 href=#__codelineno-4-145></a>        <span class=k>async</span> <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>SessionLocal</span><span class=p>()</span> <span class=k>as</span> <span class=n>session</span><span class=p>:</span>
<a id=__codelineno-4-146 name=__codelineno-4-146 href=#__codelineno-4-146></a>            <span class=n>stmt</span> <span class=o>=</span> <span class=p>(</span>
<a id=__codelineno-4-147 name=__codelineno-4-147 href=#__codelineno-4-147></a>                <span class=n>select</span><span class=p>(</span><span class=n>Pulse</span><span class=p>)</span>
<a id=__codelineno-4-148 name=__codelineno-4-148 href=#__codelineno-4-148></a>                <span class=o>.</span><span class=n>where</span><span class=p>(</span><span class=n>Pulse</span><span class=o>.</span><span class=n>status</span><span class=o>.</span><span class=n>in_</span><span class=p>(</span><span class=n>include_statuses</span><span class=p>))</span>
<a id=__codelineno-4-149 name=__codelineno-4-149 href=#__codelineno-4-149></a>                <span class=o>.</span><span class=n>order_by</span><span class=p>(</span><span class=n>Pulse</span><span class=o>.</span><span class=n>scheduled_at</span><span class=p>)</span>
<a id=__codelineno-4-150 name=__codelineno-4-150 href=#__codelineno-4-150></a>                <span class=o>.</span><span class=n>limit</span><span class=p>(</span><span class=n>limit</span><span class=p>)</span>
<a id=__codelineno-4-151 name=__codelineno-4-151 href=#__codelineno-4-151></a>            <span class=p>)</span>
<a id=__codelineno-4-152 name=__codelineno-4-152 href=#__codelineno-4-152></a>
<a id=__codelineno-4-153 name=__codelineno-4-153 href=#__codelineno-4-153></a>            <span class=n>result</span> <span class=o>=</span> <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>execute</span><span class=p>(</span><span class=n>stmt</span><span class=p>)</span>
<a id=__codelineno-4-154 name=__codelineno-4-154 href=#__codelineno-4-154></a>            <span class=k>return</span> <span class=nb>list</span><span class=p>(</span><span class=n>result</span><span class=o>.</span><span class=n>scalars</span><span class=p>()</span><span class=o>.</span><span class=n>all</span><span class=p>())</span>
<a id=__codelineno-4-155 name=__codelineno-4-155 href=#__codelineno-4-155></a>
<a id=__codelineno-4-156 name=__codelineno-4-156 href=#__codelineno-4-156></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>mark_processing</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>pulse_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
<a id=__codelineno-4-157 name=__codelineno-4-157 href=#__codelineno-4-157></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<a id=__codelineno-4-158 name=__codelineno-4-158 href=#__codelineno-4-158></a><span class=sd>        Mark a pulse as currently processing (prevents duplicate execution).</span>
<a id=__codelineno-4-159 name=__codelineno-4-159 href=#__codelineno-4-159></a>
<a id=__codelineno-4-160 name=__codelineno-4-160 href=#__codelineno-4-160></a><span class=sd>        Args:</span>
<a id=__codelineno-4-161 name=__codelineno-4-161 href=#__codelineno-4-161></a><span class=sd>            pulse_id: The pulse to mark</span>
<a id=__codelineno-4-162 name=__codelineno-4-162 href=#__codelineno-4-162></a>
<a id=__codelineno-4-163 name=__codelineno-4-163 href=#__codelineno-4-163></a><span class=sd>        Returns:</span>
<a id=__codelineno-4-164 name=__codelineno-4-164 href=#__codelineno-4-164></a><span class=sd>            True if successfully marked, False if pulse was already processing/completed</span>
<a id=__codelineno-4-165 name=__codelineno-4-165 href=#__codelineno-4-165></a><span class=sd>        &quot;&quot;&quot;</span>
<a id=__codelineno-4-166 name=__codelineno-4-166 href=#__codelineno-4-166></a>        <span class=k>async</span> <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>SessionLocal</span><span class=p>()</span> <span class=k>as</span> <span class=n>session</span><span class=p>:</span>
<a id=__codelineno-4-167 name=__codelineno-4-167 href=#__codelineno-4-167></a>            <span class=n>pulse</span> <span class=o>=</span> <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>Pulse</span><span class=p>,</span> <span class=n>pulse_id</span><span class=p>)</span>
<a id=__codelineno-4-168 name=__codelineno-4-168 href=#__codelineno-4-168></a>
<a id=__codelineno-4-169 name=__codelineno-4-169 href=#__codelineno-4-169></a>            <span class=k>if</span> <span class=ow>not</span> <span class=n>pulse</span> <span class=ow>or</span> <span class=n>pulse</span><span class=o>.</span><span class=n>status</span> <span class=o>!=</span> <span class=n>PulseStatus</span><span class=o>.</span><span class=n>PENDING</span><span class=p>:</span>
<a id=__codelineno-4-170 name=__codelineno-4-170 href=#__codelineno-4-170></a>                <span class=k>return</span> <span class=kc>False</span>
<a id=__codelineno-4-171 name=__codelineno-4-171 href=#__codelineno-4-171></a>
<a id=__codelineno-4-172 name=__codelineno-4-172 href=#__codelineno-4-172></a>            <span class=n>pulse</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=n>PulseStatus</span><span class=o>.</span><span class=n>PROCESSING</span>
<a id=__codelineno-4-173 name=__codelineno-4-173 href=#__codelineno-4-173></a>            <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
<a id=__codelineno-4-174 name=__codelineno-4-174 href=#__codelineno-4-174></a>            <span class=k>return</span> <span class=kc>True</span>
<a id=__codelineno-4-175 name=__codelineno-4-175 href=#__codelineno-4-175></a>
<a id=__codelineno-4-176 name=__codelineno-4-176 href=#__codelineno-4-176></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>mark_completed</span><span class=p>(</span>
<a id=__codelineno-4-177 name=__codelineno-4-177 href=#__codelineno-4-177></a>        <span class=bp>self</span><span class=p>,</span>
<a id=__codelineno-4-178 name=__codelineno-4-178 href=#__codelineno-4-178></a>        <span class=n>pulse_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
<a id=__codelineno-4-179 name=__codelineno-4-179 href=#__codelineno-4-179></a>        <span class=n>execution_duration_ms</span><span class=p>:</span> <span class=nb>int</span>
<a id=__codelineno-4-180 name=__codelineno-4-180 href=#__codelineno-4-180></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=kc>None</span><span class=p>:</span>
<a id=__codelineno-4-181 name=__codelineno-4-181 href=#__codelineno-4-181></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<a id=__codelineno-4-182 name=__codelineno-4-182 href=#__codelineno-4-182></a><span class=sd>        Mark a pulse as successfully completed.</span>
<a id=__codelineno-4-183 name=__codelineno-4-183 href=#__codelineno-4-183></a>
<a id=__codelineno-4-184 name=__codelineno-4-184 href=#__codelineno-4-184></a><span class=sd>        Args:</span>
<a id=__codelineno-4-185 name=__codelineno-4-185 href=#__codelineno-4-185></a><span class=sd>            pulse_id: The pulse to mark</span>
<a id=__codelineno-4-186 name=__codelineno-4-186 href=#__codelineno-4-186></a><span class=sd>            execution_duration_ms: How long execution took</span>
<a id=__codelineno-4-187 name=__codelineno-4-187 href=#__codelineno-4-187></a><span class=sd>        &quot;&quot;&quot;</span>
<a id=__codelineno-4-188 name=__codelineno-4-188 href=#__codelineno-4-188></a>        <span class=k>async</span> <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>SessionLocal</span><span class=p>()</span> <span class=k>as</span> <span class=n>session</span><span class=p>:</span>
<a id=__codelineno-4-189 name=__codelineno-4-189 href=#__codelineno-4-189></a>            <span class=n>pulse</span> <span class=o>=</span> <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>Pulse</span><span class=p>,</span> <span class=n>pulse_id</span><span class=p>)</span>
<a id=__codelineno-4-190 name=__codelineno-4-190 href=#__codelineno-4-190></a>
<a id=__codelineno-4-191 name=__codelineno-4-191 href=#__codelineno-4-191></a>            <span class=k>if</span> <span class=n>pulse</span><span class=p>:</span>
<a id=__codelineno-4-192 name=__codelineno-4-192 href=#__codelineno-4-192></a>                <span class=n>pulse</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=n>PulseStatus</span><span class=o>.</span><span class=n>COMPLETED</span>
<a id=__codelineno-4-193 name=__codelineno-4-193 href=#__codelineno-4-193></a>                <span class=n>pulse</span><span class=o>.</span><span class=n>executed_at</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(</span><span class=n>timezone</span><span class=o>.</span><span class=n>utc</span><span class=p>)</span>
<a id=__codelineno-4-194 name=__codelineno-4-194 href=#__codelineno-4-194></a>                <span class=n>pulse</span><span class=o>.</span><span class=n>execution_duration_ms</span> <span class=o>=</span> <span class=n>execution_duration_ms</span>
<a id=__codelineno-4-195 name=__codelineno-4-195 href=#__codelineno-4-195></a>                <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
<a id=__codelineno-4-196 name=__codelineno-4-196 href=#__codelineno-4-196></a>
<a id=__codelineno-4-197 name=__codelineno-4-197 href=#__codelineno-4-197></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>mark_failed</span><span class=p>(</span>
<a id=__codelineno-4-198 name=__codelineno-4-198 href=#__codelineno-4-198></a>        <span class=bp>self</span><span class=p>,</span>
<a id=__codelineno-4-199 name=__codelineno-4-199 href=#__codelineno-4-199></a>        <span class=n>pulse_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
<a id=__codelineno-4-200 name=__codelineno-4-200 href=#__codelineno-4-200></a>        <span class=n>error_message</span><span class=p>:</span> <span class=nb>str</span><span class=p>,</span>
<a id=__codelineno-4-201 name=__codelineno-4-201 href=#__codelineno-4-201></a>        <span class=n>should_retry</span><span class=p>:</span> <span class=nb>bool</span> <span class=o>=</span> <span class=kc>True</span>
<a id=__codelineno-4-202 name=__codelineno-4-202 href=#__codelineno-4-202></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=n>Optional</span><span class=p>[</span><span class=nb>int</span><span class=p>]:</span>
<a id=__codelineno-4-203 name=__codelineno-4-203 href=#__codelineno-4-203></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<a id=__codelineno-4-204 name=__codelineno-4-204 href=#__codelineno-4-204></a><span class=sd>        Mark a pulse as failed.</span>
<a id=__codelineno-4-205 name=__codelineno-4-205 href=#__codelineno-4-205></a>
<a id=__codelineno-4-206 name=__codelineno-4-206 href=#__codelineno-4-206></a><span class=sd>        If retry is enabled and max_retries not exceeded, schedules a new</span>
<a id=__codelineno-4-207 name=__codelineno-4-207 href=#__codelineno-4-207></a><span class=sd>        retry pulse.</span>
<a id=__codelineno-4-208 name=__codelineno-4-208 href=#__codelineno-4-208></a>
<a id=__codelineno-4-209 name=__codelineno-4-209 href=#__codelineno-4-209></a><span class=sd>        Args:</span>
<a id=__codelineno-4-210 name=__codelineno-4-210 href=#__codelineno-4-210></a><span class=sd>            pulse_id: The pulse to mark as failed</span>
<a id=__codelineno-4-211 name=__codelineno-4-211 href=#__codelineno-4-211></a><span class=sd>            error_message: Description of the failure</span>
<a id=__codelineno-4-212 name=__codelineno-4-212 href=#__codelineno-4-212></a><span class=sd>            should_retry: Whether to attempt retry</span>
<a id=__codelineno-4-213 name=__codelineno-4-213 href=#__codelineno-4-213></a>
<a id=__codelineno-4-214 name=__codelineno-4-214 href=#__codelineno-4-214></a><span class=sd>        Returns:</span>
<a id=__codelineno-4-215 name=__codelineno-4-215 href=#__codelineno-4-215></a><span class=sd>            New pulse ID if retried, None otherwise</span>
<a id=__codelineno-4-216 name=__codelineno-4-216 href=#__codelineno-4-216></a><span class=sd>        &quot;&quot;&quot;</span>
<a id=__codelineno-4-217 name=__codelineno-4-217 href=#__codelineno-4-217></a>        <span class=k>async</span> <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>SessionLocal</span><span class=p>()</span> <span class=k>as</span> <span class=n>session</span><span class=p>:</span>
<a id=__codelineno-4-218 name=__codelineno-4-218 href=#__codelineno-4-218></a>            <span class=n>pulse</span> <span class=o>=</span> <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>Pulse</span><span class=p>,</span> <span class=n>pulse_id</span><span class=p>)</span>
<a id=__codelineno-4-219 name=__codelineno-4-219 href=#__codelineno-4-219></a>
<a id=__codelineno-4-220 name=__codelineno-4-220 href=#__codelineno-4-220></a>            <span class=k>if</span> <span class=ow>not</span> <span class=n>pulse</span><span class=p>:</span>
<a id=__codelineno-4-221 name=__codelineno-4-221 href=#__codelineno-4-221></a>                <span class=k>return</span> <span class=kc>None</span>
<a id=__codelineno-4-222 name=__codelineno-4-222 href=#__codelineno-4-222></a>
<a id=__codelineno-4-223 name=__codelineno-4-223 href=#__codelineno-4-223></a>            <span class=n>pulse</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=n>PulseStatus</span><span class=o>.</span><span class=n>FAILED</span>
<a id=__codelineno-4-224 name=__codelineno-4-224 href=#__codelineno-4-224></a>            <span class=n>pulse</span><span class=o>.</span><span class=n>error_message</span> <span class=o>=</span> <span class=n>error_message</span>
<a id=__codelineno-4-225 name=__codelineno-4-225 href=#__codelineno-4-225></a>            <span class=n>pulse</span><span class=o>.</span><span class=n>executed_at</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(</span><span class=n>timezone</span><span class=o>.</span><span class=n>utc</span><span class=p>)</span>
<a id=__codelineno-4-226 name=__codelineno-4-226 href=#__codelineno-4-226></a>
<a id=__codelineno-4-227 name=__codelineno-4-227 href=#__codelineno-4-227></a>            <span class=c1># Retry logic</span>
<a id=__codelineno-4-228 name=__codelineno-4-228 href=#__codelineno-4-228></a>            <span class=n>new_pulse_id</span> <span class=o>=</span> <span class=kc>None</span>
<a id=__codelineno-4-229 name=__codelineno-4-229 href=#__codelineno-4-229></a>            <span class=k>if</span> <span class=n>should_retry</span> <span class=ow>and</span> <span class=n>pulse</span><span class=o>.</span><span class=n>retry_count</span> <span class=o>&lt;</span> <span class=n>pulse</span><span class=o>.</span><span class=n>max_retries</span><span class=p>:</span>
<a id=__codelineno-4-230 name=__codelineno-4-230 href=#__codelineno-4-230></a>                <span class=c1># Schedule retry with exponential backoff: 2^retry_count minutes</span>
<a id=__codelineno-4-231 name=__codelineno-4-231 href=#__codelineno-4-231></a>                <span class=n>retry_delay_minutes</span> <span class=o>=</span> <span class=mi>2</span> <span class=o>**</span> <span class=n>pulse</span><span class=o>.</span><span class=n>retry_count</span>
<a id=__codelineno-4-232 name=__codelineno-4-232 href=#__codelineno-4-232></a>                <span class=n>retry_at</span> <span class=o>=</span> <span class=n>datetime</span><span class=o>.</span><span class=n>now</span><span class=p>(</span><span class=n>timezone</span><span class=o>.</span><span class=n>utc</span><span class=p>)</span> <span class=o>+</span> <span class=n>timedelta</span><span class=p>(</span><span class=n>minutes</span><span class=o>=</span><span class=n>retry_delay_minutes</span><span class=p>)</span>
<a id=__codelineno-4-233 name=__codelineno-4-233 href=#__codelineno-4-233></a>
<a id=__codelineno-4-234 name=__codelineno-4-234 href=#__codelineno-4-234></a>                <span class=n>retry_pulse</span> <span class=o>=</span> <span class=n>Pulse</span><span class=p>(</span>
<a id=__codelineno-4-235 name=__codelineno-4-235 href=#__codelineno-4-235></a>                    <span class=n>scheduled_at</span><span class=o>=</span><span class=n>retry_at</span><span class=p>,</span>
<a id=__codelineno-4-236 name=__codelineno-4-236 href=#__codelineno-4-236></a>                    <span class=n>prompt</span><span class=o>=</span><span class=n>pulse</span><span class=o>.</span><span class=n>prompt</span><span class=p>,</span>
<a id=__codelineno-4-237 name=__codelineno-4-237 href=#__codelineno-4-237></a>                    <span class=n>priority</span><span class=o>=</span><span class=n>pulse</span><span class=o>.</span><span class=n>priority</span><span class=p>,</span>
<a id=__codelineno-4-238 name=__codelineno-4-238 href=#__codelineno-4-238></a>                    <span class=n>session_id</span><span class=o>=</span><span class=n>pulse</span><span class=o>.</span><span class=n>session_id</span><span class=p>,</span>
<a id=__codelineno-4-239 name=__codelineno-4-239 href=#__codelineno-4-239></a>                    <span class=n>sticky_notes</span><span class=o>=</span><span class=n>pulse</span><span class=o>.</span><span class=n>sticky_notes</span><span class=p>,</span>
<a id=__codelineno-4-240 name=__codelineno-4-240 href=#__codelineno-4-240></a>                    <span class=n>tags</span><span class=o>=</span><span class=n>pulse</span><span class=o>.</span><span class=n>tags</span><span class=p>,</span>
<a id=__codelineno-4-241 name=__codelineno-4-241 href=#__codelineno-4-241></a>                    <span class=n>created_by</span><span class=o>=</span><span class=sa>f</span><span class=s2>&quot;retry_</span><span class=si>{</span><span class=n>pulse</span><span class=o>.</span><span class=n>created_by</span><span class=si>}</span><span class=s2>&quot;</span><span class=p>,</span>
<a id=__codelineno-4-242 name=__codelineno-4-242 href=#__codelineno-4-242></a>                    <span class=n>max_retries</span><span class=o>=</span><span class=n>pulse</span><span class=o>.</span><span class=n>max_retries</span><span class=p>,</span>
<a id=__codelineno-4-243 name=__codelineno-4-243 href=#__codelineno-4-243></a>                    <span class=n>retry_count</span><span class=o>=</span><span class=n>pulse</span><span class=o>.</span><span class=n>retry_count</span> <span class=o>+</span> <span class=mi>1</span><span class=p>,</span>
<a id=__codelineno-4-244 name=__codelineno-4-244 href=#__codelineno-4-244></a>                    <span class=n>status</span><span class=o>=</span><span class=n>PulseStatus</span><span class=o>.</span><span class=n>PENDING</span>
<a id=__codelineno-4-245 name=__codelineno-4-245 href=#__codelineno-4-245></a>                <span class=p>)</span>
<a id=__codelineno-4-246 name=__codelineno-4-246 href=#__codelineno-4-246></a>
<a id=__codelineno-4-247 name=__codelineno-4-247 href=#__codelineno-4-247></a>                <span class=n>session</span><span class=o>.</span><span class=n>add</span><span class=p>(</span><span class=n>retry_pulse</span><span class=p>)</span>
<a id=__codelineno-4-248 name=__codelineno-4-248 href=#__codelineno-4-248></a>                <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>flush</span><span class=p>()</span>
<a id=__codelineno-4-249 name=__codelineno-4-249 href=#__codelineno-4-249></a>                <span class=n>new_pulse_id</span> <span class=o>=</span> <span class=n>retry_pulse</span><span class=o>.</span><span class=n>id</span>
<a id=__codelineno-4-250 name=__codelineno-4-250 href=#__codelineno-4-250></a>
<a id=__codelineno-4-251 name=__codelineno-4-251 href=#__codelineno-4-251></a>            <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
<a id=__codelineno-4-252 name=__codelineno-4-252 href=#__codelineno-4-252></a>            <span class=k>return</span> <span class=n>new_pulse_id</span>
<a id=__codelineno-4-253 name=__codelineno-4-253 href=#__codelineno-4-253></a>
<a id=__codelineno-4-254 name=__codelineno-4-254 href=#__codelineno-4-254></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>cancel_pulse</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>pulse_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
<a id=__codelineno-4-255 name=__codelineno-4-255 href=#__codelineno-4-255></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<a id=__codelineno-4-256 name=__codelineno-4-256 href=#__codelineno-4-256></a><span class=sd>        Cancel a pending pulse.</span>
<a id=__codelineno-4-257 name=__codelineno-4-257 href=#__codelineno-4-257></a>
<a id=__codelineno-4-258 name=__codelineno-4-258 href=#__codelineno-4-258></a><span class=sd>        Args:</span>
<a id=__codelineno-4-259 name=__codelineno-4-259 href=#__codelineno-4-259></a><span class=sd>            pulse_id: The pulse to cancel</span>
<a id=__codelineno-4-260 name=__codelineno-4-260 href=#__codelineno-4-260></a>
<a id=__codelineno-4-261 name=__codelineno-4-261 href=#__codelineno-4-261></a><span class=sd>        Returns:</span>
<a id=__codelineno-4-262 name=__codelineno-4-262 href=#__codelineno-4-262></a><span class=sd>            True if cancelled, False if pulse was not in cancellable state</span>
<a id=__codelineno-4-263 name=__codelineno-4-263 href=#__codelineno-4-263></a><span class=sd>        &quot;&quot;&quot;</span>
<a id=__codelineno-4-264 name=__codelineno-4-264 href=#__codelineno-4-264></a>        <span class=k>async</span> <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>SessionLocal</span><span class=p>()</span> <span class=k>as</span> <span class=n>session</span><span class=p>:</span>
<a id=__codelineno-4-265 name=__codelineno-4-265 href=#__codelineno-4-265></a>            <span class=n>pulse</span> <span class=o>=</span> <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>Pulse</span><span class=p>,</span> <span class=n>pulse_id</span><span class=p>)</span>
<a id=__codelineno-4-266 name=__codelineno-4-266 href=#__codelineno-4-266></a>
<a id=__codelineno-4-267 name=__codelineno-4-267 href=#__codelineno-4-267></a>            <span class=k>if</span> <span class=ow>not</span> <span class=n>pulse</span> <span class=ow>or</span> <span class=n>pulse</span><span class=o>.</span><span class=n>status</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>[</span><span class=n>PulseStatus</span><span class=o>.</span><span class=n>PENDING</span><span class=p>]:</span>
<a id=__codelineno-4-268 name=__codelineno-4-268 href=#__codelineno-4-268></a>                <span class=k>return</span> <span class=kc>False</span>
<a id=__codelineno-4-269 name=__codelineno-4-269 href=#__codelineno-4-269></a>
<a id=__codelineno-4-270 name=__codelineno-4-270 href=#__codelineno-4-270></a>            <span class=n>pulse</span><span class=o>.</span><span class=n>status</span> <span class=o>=</span> <span class=n>PulseStatus</span><span class=o>.</span><span class=n>CANCELLED</span>
<a id=__codelineno-4-271 name=__codelineno-4-271 href=#__codelineno-4-271></a>            <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
<a id=__codelineno-4-272 name=__codelineno-4-272 href=#__codelineno-4-272></a>            <span class=k>return</span> <span class=kc>True</span>
<a id=__codelineno-4-273 name=__codelineno-4-273 href=#__codelineno-4-273></a>
<a id=__codelineno-4-274 name=__codelineno-4-274 href=#__codelineno-4-274></a>    <span class=k>async</span> <span class=k>def</span><span class=w> </span><span class=nf>reschedule_pulse</span><span class=p>(</span>
<a id=__codelineno-4-275 name=__codelineno-4-275 href=#__codelineno-4-275></a>        <span class=bp>self</span><span class=p>,</span>
<a id=__codelineno-4-276 name=__codelineno-4-276 href=#__codelineno-4-276></a>        <span class=n>pulse_id</span><span class=p>:</span> <span class=nb>int</span><span class=p>,</span>
<a id=__codelineno-4-277 name=__codelineno-4-277 href=#__codelineno-4-277></a>        <span class=n>new_scheduled_at</span><span class=p>:</span> <span class=n>datetime</span>
<a id=__codelineno-4-278 name=__codelineno-4-278 href=#__codelineno-4-278></a>    <span class=p>)</span> <span class=o>-&gt;</span> <span class=nb>bool</span><span class=p>:</span>
<a id=__codelineno-4-279 name=__codelineno-4-279 href=#__codelineno-4-279></a><span class=w>        </span><span class=sd>&quot;&quot;&quot;</span>
<a id=__codelineno-4-280 name=__codelineno-4-280 href=#__codelineno-4-280></a><span class=sd>        Reschedule a pending pulse to a different time.</span>
<a id=__codelineno-4-281 name=__codelineno-4-281 href=#__codelineno-4-281></a>
<a id=__codelineno-4-282 name=__codelineno-4-282 href=#__codelineno-4-282></a><span class=sd>        Args:</span>
<a id=__codelineno-4-283 name=__codelineno-4-283 href=#__codelineno-4-283></a><span class=sd>            pulse_id: The pulse to reschedule</span>
<a id=__codelineno-4-284 name=__codelineno-4-284 href=#__codelineno-4-284></a><span class=sd>            new_scheduled_at: New execution time</span>
<a id=__codelineno-4-285 name=__codelineno-4-285 href=#__codelineno-4-285></a>
<a id=__codelineno-4-286 name=__codelineno-4-286 href=#__codelineno-4-286></a><span class=sd>        Returns:</span>
<a id=__codelineno-4-287 name=__codelineno-4-287 href=#__codelineno-4-287></a><span class=sd>            True if rescheduled, False if pulse was not pending</span>
<a id=__codelineno-4-288 name=__codelineno-4-288 href=#__codelineno-4-288></a><span class=sd>        &quot;&quot;&quot;</span>
<a id=__codelineno-4-289 name=__codelineno-4-289 href=#__codelineno-4-289></a>        <span class=k>async</span> <span class=k>with</span> <span class=bp>self</span><span class=o>.</span><span class=n>SessionLocal</span><span class=p>()</span> <span class=k>as</span> <span class=n>session</span><span class=p>:</span>
<a id=__codelineno-4-290 name=__codelineno-4-290 href=#__codelineno-4-290></a>            <span class=n>pulse</span> <span class=o>=</span> <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>get</span><span class=p>(</span><span class=n>Pulse</span><span class=p>,</span> <span class=n>pulse_id</span><span class=p>)</span>
<a id=__codelineno-4-291 name=__codelineno-4-291 href=#__codelineno-4-291></a>
<a id=__codelineno-4-292 name=__codelineno-4-292 href=#__codelineno-4-292></a>            <span class=k>if</span> <span class=ow>not</span> <span class=n>pulse</span> <span class=ow>or</span> <span class=n>pulse</span><span class=o>.</span><span class=n>status</span> <span class=o>!=</span> <span class=n>PulseStatus</span><span class=o>.</span><span class=n>PENDING</span><span class=p>:</span>
<a id=__codelineno-4-293 name=__codelineno-4-293 href=#__codelineno-4-293></a>                <span class=k>return</span> <span class=kc>False</span>
<a id=__codelineno-4-294 name=__codelineno-4-294 href=#__codelineno-4-294></a>
<a id=__codelineno-4-295 name=__codelineno-4-295 href=#__codelineno-4-295></a>            <span class=n>pulse</span><span class=o>.</span><span class=n>scheduled_at</span> <span class=o>=</span> <span class=n>new_scheduled_at</span>
<a id=__codelineno-4-296 name=__codelineno-4-296 href=#__codelineno-4-296></a>            <span class=k>await</span> <span class=n>session</span><span class=o>.</span><span class=n>commit</span><span class=p>()</span>
<a id=__codelineno-4-297 name=__codelineno-4-297 href=#__codelineno-4-297></a>            <span class=k>return</span> <span class=kc>True</span>
</code></pre></div> <h2 id=design-decisions-rationale>Design Decisions &amp; Rationale<a class=headerlink href=#design-decisions-rationale title="Permanent link">&para;</a></h2> <h3 id=1-why-async-sqlalchemy>1. Why Async SQLAlchemy?<a class=headerlink href=#1-why-async-sqlalchemy title="Permanent link">&para;</a></h3> <p><strong>Decision</strong>: Use <code>AsyncSession</code> and <code>async_sessionmaker</code></p> <p><strong>Rationale</strong>: - Daemon runs an asyncio event loop (concurrent MCP server + HTTP API + scheduler) - Blocking DB calls would stall the entire event loop - Async allows thousands of concurrent operations - Future-proof for high-throughput scenarios</p> <h3 id=2-why-string-enums>2. Why String Enums?<a class=headerlink href=#2-why-string-enums title="Permanent link">&para;</a></h3> <p><strong>Decision</strong>: <code>class PulsePriority(str, Enum)</code></p> <p><strong>Rationale</strong>: - JSON-serializable (for API responses, MCP tool returns) - Human-readable in database (SQLite browser shows "high" not 2) - Type-safe in Python code - Better error messages ("got 'urgent', expected 'high'")</p> <h3 id=3-why-composite-indexes>3. Why Composite Indexes?<a class=headerlink href=#3-why-composite-indexes title="Permanent link">&para;</a></h3> <p><strong>Decision</strong>: <code>Index('idx_pulse_execution', 'status', 'scheduled_at', 'priority')</code></p> <p><strong>Rationale</strong>: - The main query (<code>get_due_pulses</code>) filters by status + scheduled_at, sorts by priority - Composite index covers entire query (no table scan) - SQLite can use leftmost prefix for other queries - Tradeoff: Slightly slower writes (index maintenance), but reads are 100x faster</p> <h3 id=4-why-retry-logic-in-db>4. Why Retry Logic in DB?<a class=headerlink href=#4-why-retry-logic-in-db title="Permanent link">&para;</a></h3> <p><strong>Decision</strong>: Store <code>retry_count</code> and <code>max_retries</code> in Pulse model</p> <p><strong>Rationale</strong>: - Self-contained: Each pulse knows its own retry policy - Exponential backoff: 1min ‚Üí 2min ‚Üí 4min ‚Üí 8min - Failure forensics: Can query "which pulses failed repeatedly?" - Future: Could add per-priority retry policies</p> <h3 id=5-why-separate-created_by-field>5. Why Separate <code>created_by</code> Field?<a class=headerlink href=#5-why-separate-created_by-field title="Permanent link">&para;</a></h3> <p><strong>Decision</strong>: Track who/what created each pulse</p> <p><strong>Rationale</strong>: - Debugging: "Why did this pulse fire?" - Analytics: "How many pulses come from Telegram vs. Reeve itself?" - Audit trail: Security/compliance - Future: Rate limiting per source</p> <h2 id=execution-flow>Execution Flow<a class=headerlink href=#execution-flow title="Permanent link">&para;</a></h2> <h3 id=daemon-main-loop>Daemon Main Loop<a class=headerlink href=#daemon-main-loop title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a>‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
<a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a>‚îÇ  While True (every 1 second):           ‚îÇ
<a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>‚îÇ                                         ‚îÇ
<a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a>‚îÇ  1. Get due pulses from queue           ‚îÇ
<a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a>‚îÇ  2. For each pulse (up to 10):          ‚îÇ
<a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>‚îÇ     a. Mark as PROCESSING               ‚îÇ
<a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a>‚îÇ     b. Launch Hapi session (async)      ‚îÇ
<a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>‚îÇ     c. Wait for completion              ‚îÇ
<a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a>‚îÇ     d. Mark as COMPLETED/FAILED         ‚îÇ
<a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a>‚îÇ  3. Sleep 1 second                      ‚îÇ
<a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a>‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
</code></pre></div> <p><strong>Why 1 second polling?</strong> - Sub-second precision (vs. cron's 1-minute minimum) - Low CPU overhead (DB query is cheap with indexes) - Can batch multiple due pulses in one iteration - Future: Could use DB triggers + notify/listen for zero-latency</p> <h3 id=parallel-execution>Parallel Execution<a class=headerlink href=#parallel-execution title="Permanent link">&para;</a></h3> <p><strong>Option A: Sequential</strong> (Initial Implementation) - Process one pulse at a time - Simple, predictable - Good for debugging</p> <p><strong>Option B: Parallel</strong> (Future Optimization) - Process up to N pulses concurrently - Faster overall throughput - Risk: Resource contention (CPU, Hapi sessions)</p> <p><strong>Recommendation</strong>: Start with Sequential, add Parallel after observing real-world load.</p> <h2 id=next-steps>Next Steps<a class=headerlink href=#next-steps title="Permanent link">&para;</a></h2> <p>See <strong><a href=../mcp-integration/ >mcp-integration.md</a></strong> for how Reeve interacts with this queue via MCP tools.</p> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"annotate": null, "base": "../..", "features": ["navigation.instant", "navigation.tracking", "navigation.sections", "navigation.expand", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script> <script src=../../assets/javascripts/bundle.79ae519e.min.js></script> <script src=https://unpkg.com/mermaid@10/dist/mermaid.min.js></script> </body> </html>